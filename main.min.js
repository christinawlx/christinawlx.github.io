var BattleCardData=function(){function t(){this._name="",this._sta=new Status("attack"),this._haveCard=!0}var e=(__define,t);return p=e.prototype,p.getAtk=function(t){return this._attack*this._sta.Number*t/3},p.AtkNum=function(){return this._attack},t}();egret.registerClass(BattleCardData,"BattleCardData");var BattleMain=function(t){function e(){t.call(this),this.enemys=[],this.curStage=0,this.focusEnemy=-1,this.damaBuf=1,this.waitforAtk=!1,this.enemyMark=[],this.pub_timer=new egret.Timer(20),this.DisCombo=new egret.TextField,this.banTouch=new egret.Bitmap,this.showStage=new egret.TextField}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(t){this.focusEnemy=-1,this.player=new BattlePlayer,this.player.Init(0),this.applyLSkill("Init");for(var e=RES.getRes(t+"_json"),i=0;i<e.enemys.length;i++){for(var s=[],a=0;a<e.enemys[i].length;a++){var h=new Enemy,r=e.enemys[i][a];h.Init(r.name,r.level,r.element),h.y=82*a,h._id=a,h.touchEnabled=!0,h.addEventListener(egret.TouchEvent.TOUCH_TAP,this.ChangeFocus,this),s.push(h)}this.enemys.push(s)}var n=new egret.Bitmap,o=e.bg;n.texture=RES.getRes(o),n.touchEnabled=!0,this.addChild(n),this.displayEnemy=new egret.DisplayObjectContainer,this.displayEnemy.x=950,this.displayEnemy.y=190,this.damageSys=new DamageSys,this.addChild(this.DisCombo),this.addChild(this.damageSys),this.addChild(this.player),this.addChild(this.displayEnemy),this.focusMark=new egret.Bitmap,this.focusMark.texture=RES.getRes("BATfocusMark"),this.focusMark.y=this.enemys[0][0].y+40,this.addChild(this.focusMark),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.added,this),this.player.addEventListener("Player die",this.PlayerDie,this),this.player.addEventListener("Skill",this.applySkill,this),this.damageSys.addEventListener("add MP",this.player.addMP,this.player),this.damageSys.addEventListener(GameEvent.CHAIN_OVER,this.chainover,this),this.atkTexture=RES.getRes("BATtestParticle_png"),this.atkConfig=RES.getRes("BATtestParticle_json"),this.DisCombo.fontFamily="Colonna MT",this.DisCombo.stroke=2,this.DisCombo.strokeColor=0,this.DisCombo.x=740,this.DisCombo.y=130,this.DisCombo.size=40,this.showStage.fontFamily="Stencil",this.showStage.stroke=2,this.showStage.strokeColor=0,this.showStage.x=540,this.showStage.y=370,this.showStage.size=40,this.banTouch.texture=RES.getRes("MAINblack"),this.banTouch.alpha=.5,this.banTouch.width=500,this.banTouch.height=500,this.banTouch.x=394,this.banTouch.y=181,this.focusMark.visible=!1,this.player.addEventListener(GameEvent.STOP_BATTLE_PROC,this.pause,this),this.player.addEventListener(GameEvent.CONTINUE_BATTLE,this["continue"],this)},p.added=function(){this.playStage(),this.pub_timer.addEventListener(egret.TimerEvent.TIMER,this.update,this)},p.playStage=function(){this.displayEnemy.removeChildren();for(var t=0;t<this.enemys[this.curStage].length;t++)this.displayEnemy.addChild(this.enemys[this.curStage][t]);this.damageSys.readyAction(),this.InitTimeLine(),this.touchChildren=!1,this.playStageAni()},p.playStageAni=function(){var t=this.displayEnemy.x;this.displayEnemy.x=1280,egret.Tween.get(this.displayEnemy).to({x:t},1200,egret.Ease.circOut),this.addChild(this.banTouch),this.banTouch.alpha=.5,egret.Tween.get(this.banTouch).to({},1e3).to({alpha:0},1e3).call(this.endStageAni,this),this.addChild(this.showStage),this.showStage.text="STAGE "+(this.curStage+1).toString()+"/"+this.enemys.length.toString();var e=this.showStage.y;this.showStage.y+=15,this.showStage.alpha=0,egret.Tween.get(this.showStage).to({y:e,alpha:1},500).to({},1e3).to({alpha:0,y:e-=15},500)},p.endStageAni=function(){this.touchChildren=!0,this.pub_timer.start(),this.showStage.y=370,null!=this.banTouch.parent&&this.removeChild(this.banTouch),null!=this.showStage.parent&&this.removeChild(this.showStage)},p.InitTimeLine=function(){0==this.curStage&&(this.timeline=new egret.Bitmap,this.timeline.texture=RES.getRes("BATtimeline"),this.addChild(this.timeline),this.timeline.x=338,this.timeline.y=10,this.playerMark=new egret.Bitmap,this.playerMark.texture=RES.getRes("BATplayer_mark"),this.playerMark.x=this.timeline.x,this.playerMark.y=this.timeline.y+2,this.addChild(this.playerMark)),this.enemyMark=[];for(var t=0;t<this.enemys[this.curStage].length;t++){var e=new egret.Bitmap;e.texture=RES.getRes("BATenemy_mark"),e.x=this.timeline.x,e.y=this.timeline.y+2,this.enemyMark.push(e),this.addChild(e)}},p.update=function(){for(var t=!0,e=0;e<this.enemys[this.curStage].length;e++)this.enemys[this.curStage][e]._isDead?null!=this.enemyMark[e].parent&&this.enemyMark[e].parent.removeChild(this.enemyMark[e]):(t=!1,this.enemys[this.curStage][e].Move()&&this.player.Damage(this.enemys[this.curStage][e].Attack()));if(t&&this.StageClear(),!this.player._isDead){if(this.player.Move())return this.pub_timer.stop(),this.pub_timer.reset(),void this.CheckDamageSys();this.updateTimeLine(),this.updateFocus()}},p.updateFocus=function(){-1==this.focusEnemy?this.focusMark.visible=!1:(this.focusMark.x=this.displayEnemy.x,this.focusMark.y=this.enemys[this.curStage][this.focusEnemy].y+this.displayEnemy.y,this.focusMark.visible=!0)},p.updateTimeLine=function(){this.playerMark.x=this.timeline.x+this.player.getRelativeSC()*(this.timeline.width-30);for(var t=0;t<this.enemyMark.length;t++)this.enemys[this.curStage][t]._lock||(this.enemyMark[t].x=this.timeline.x+this.enemys[this.curStage][t].getRelativeSC()*(this.timeline.width-25))},p.backTimeLine=function(t){var e=this.timeline.x+this.enemys[this.curStage][t].getRelativeSC()*(this.timeline.width-25);console.log(e),egret.Tween.get(this.enemyMark[t]).to({x:e},3*(this.enemyMark[t].x-e),egret.Ease.backIn).to({x:e},200).call(this.enemys[this.curStage][t].unlock,this.enemys[this.curStage][t])},p.CheckDamageSys=function(){this.damageSys.actover?this.PAttack():(this.damageSys.addEventListener("actover",this.PAttack,this),this.waitforAtk=!0)},p.chainover=function(){this.player.updateTarData(this.damageSys._elements),this.updateCombo()},p.updateCombo=function(){this.damageSys._combo>0?this.DisCombo.text="COMBO  "+this.damageSys._combo:this.DisCombo.text=""},p.PAttack=function(){this.waitforAtk=!1,this.applyLSkill("battle"),this.damageSys.calcuCombo();for(var t,e,i,s=0;s<this.player.dataRole.length;s++)if(this.player.dataRole[s]._haveCard){if(t=this.SelectEnemy(),-1==t)break;e=this.player.dataRole[s]._element,i=this.player.dataRole[s].getAtk(this.damageSys._elements[e])*this.damaBuf,this.enemys[this.curStage][t].Damage(i,e),0!=i&&this.playAni(s,t)}this.damaBuf=1;var a=this.damageSys._elements[0];this.player.Cure(a),-1!=this.focusEnemy&&this.enemys[this.curStage][this.focusEnemy]._isDead&&(this.focusEnemy=-1),this.damageSys.removeEventListener("actover",this.PAttack,this),this.player.AttackAni(),this.updateCombo(),this.player.addEventListener("attack over",this.RestartAction,this)},p.RestartAction=function(){this.pub_timer.start(),this.player.UpdateStatus();for(var t=0;t<this.enemys[this.curStage].length;t++)if(!this.enemys[this.curStage][t]._isDead){this.damageSys.readyAction();break}this.player.removeEventListener("attack over",this.RestartAction,this)},p.SelectEnemy=function(){for(var t=!0,e=0;e<this.enemys[this.curStage].length;e++)this.enemys[this.curStage][e]._isDead||(t=!1);if(t)return-1;var i=Math.floor(Math.random()*this.enemys[this.curStage].length);for(-1!=this.focusEnemy&&(i=this.focusEnemy);this.enemys[this.curStage][i]._isDead;)i=Math.floor(Math.random()*this.enemys[this.curStage].length);return i},p.PlayerDie=function(){this.pub_timer.stop(),this.pub_timer.reset(),this.damageSys.touchChildren=!1,this.player.touchChildren=!1,this.displayEnemy.touchChildren=!1,console.log("gameover"),this.dispatchEvent(new egret.Event(GameEvent.LOSE_FROM_BAT))},p.StageClear=function(){return this.pub_timer.stop(),this.pub_timer.reset(),this.focusEnemy=-1,this.curStage==this.enemys.length-1?void this.WinBattle():(this.curStage++,this.player.resetCount(),this.playStage(),this.removeChild(this.focusMark),void this.addChild(this.focusMark))},p.WinBattle=function(){this.dispatchEvent(new egret.Event(GameEvent.WIN_BATTLE))},p.ChangeFocus=function(t){this.focusEnemy==t.target._id?this.focusEnemy=-1:this.focusEnemy=t.target._id,this.updateFocus()},p.playAni=function(t,e){var i=new particle.GravityParticleSystem(this.atkTexture,this.atkConfig);i.emitterX=this.player.x+this.player.disRole[t].x+SystemData.wCardW/2,i.emitterY=this.player.y+this.player.disRole[t].y+SystemData.wCardH/2,i.start(),this.addChild(i);var s=this.enemys[this.curStage][e].x+this.displayEnemy.x+SystemData.wCardW/2,a=this.enemys[this.curStage][e].y+this.displayEnemy.y+SystemData.wCardH/2;egret.Tween.get(i).to({emitterX:s,emitterY:a},500,egret.Ease.circInOut).call(function(){null!=i.parent&&i.parent.removeChild(i)},this)},p.applySkill=function(t){switch(t.data._name){case"BackTimeLine":if(0==t.data._val2){var e=this.SelectEnemy();this.enemys[this.curStage][e].back(t.data._val1),this.backTimeLine(e)}else if(1==t.data._val2)for(var i=0;i<this.enemys[this.curStage].length;i++)this.enemys[this.curStage][i].back(t.data._val1),this.backTimeLine(i);break;case"Cure":this.player.Cure(t.data._val1);break;case"Change":this.damageSys.Change(t.data._val1,t.data._val2);break;case"AddColor":this.damageSys.AddColor(t.data._val1,t.data._val2,t.data._val3),this.addChild(this.damageSys.statusC);break;case"AddStatus":this.player.AddStatus(t.data._val1,t.data._val2,t.data._val3);break;case"Strenthen":this.player.AddAttack(t.data._val1,t.data._val2,t.data._val3)}},p.applyLSkill=function(t){var e=SkillManage.CreateLeaderSkill(this.player.getLeaderName());if("NULL"!=e._name)if("COLOR"==e._name&&"battle"==t){var i=this.damageSys.applyLSkill(e);i&&(this.damaBuf=e._val1)}else"STREN"==e._name&&"Init"==t&&this.player.strenGroup(e)},p.pause=function(){this.pub_timer.stop(),this.damageSys.pause(!0),this.touchChildren=!1,this.damageSys.skillLock=!0},p["continue"]=function(){this.waitforAtk||this.pub_timer.start(),this.damageSys.pause(!1),this.touchChildren=!0,this.damageSys.skillLock=!1},e.PSpeedCount=100,e}(egret.DisplayObjectContainer);egret.registerClass(BattleMain,"BattleMain");var BattlePlayer=function(t){function e(){t.call(this),this._maxhp=1e3,this._curhp=1e3,this._maxmp=50,this._curmp=0,this._cure=100,this._speed=200,this.speedcount=0,this._isDead=!1,this.MPnumMax=new egret.TextField,this.mpMask=new egret.Rectangle(0,0,128,123),this.dataRole=[],this.disRole=[],this.status=[],this.atkData=[],this.tarData=[],this.atkText=[],this.cureData=0,this.tarCure=0,this.cureHP=new egret.Bitmap,this.cureText=new egret.TextField,this.damText=[],this.anicount=0,this._timer=new egret.Timer(20)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.getLeaderName=function(){return this.dataRole[0]._name},p.Init=function(t){this.InitData(t),this.InitDisPlay(t),this.status.push(new Status("defense")),this.status.push(new Status("speed")),this.status[0].x=175,this.status[0].y=113,this.status[1].x=230,this.status[1].y=113,this._timer.addEventListener(egret.TimerEvent.TIMER,this.updateAtkData,this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.added,this)},p.added=function(){this._timer.start()},p.InitData=function(t){PlayerData.sumAttributes(t),this._maxhp=PlayerData.sumHP,this._curhp=this._maxhp,this._maxmp=PlayerData.sumMP,this._speed=200+PlayerData.sumSp,this._cure=PlayerData.sumCur;for(var e=0;e<PlayerData._savedGroup[t].length;e++){var i=new BattleCardData;if(-1!=PlayerData._savedGroup[t][e]){var s=PlayerData._savedGroup[t][e];i._pid=s,i._attack=PlayerData._ownCards[s]._attack,i._name=PlayerData._ownCards[s]._name,i._passiveSkill=0,i._element=PlayerData._ownCards[s]._element;var a=RES.getRes(i._name+"_json"),h=a.skillcost;i._skillcost=h,i._skillname=a.skillname}else i._haveCard=!1;this.dataRole.push(i)}for(var e=0;e<this.dataRole.length;e++)this.atkData.push(0),this.tarData.push(0)},p.InitDisPlay=function(t){for(var e=0;e<this.dataRole.length;e++){var i=new DisplayCard;i.SetContent(PlayerData._savedGroup[t][e],"icon"),i.x=107,i.y=170+82*e,i.gid=e,i.touchEnabled=!0,i.addEventListener(egret.TouchEvent.TOUCH_TAP,this.tapIcon,this),this.disRole.push(i),this.addChild(i),this.dataRole[e]._sta.x=i.x+30,this.dataRole[e]._sta.y=i.y+50}for(var e=0;e<this.dataRole.length;e++){var s=new egret.TextField;s.fontFamily="Colonna MT",s.stroke=2,s.strokeColor=16777215,this.atkText.push(s),this.addChild(s),s.size=45,s.x=this.disRole[e].x+185,s.y=this.disRole[e].y+23,1==this.dataRole[e]._element?this.atkText[e].textColor=16711680:2==this.dataRole[e]._element?this.atkText[e].textColor=255:3==this.dataRole[e]._element?this.atkText[e].textColor=65280:4==this.dataRole[e]._element?this.atkText[e].textColor=16776960:5==this.dataRole[e]._element&&(this.atkText[e].textColor=5570815)}this.InitHM();for(var e=0;6>e;e++){var a=new egret.TextField;a.x=this.maxHp.x+this.maxHp.width-30*e,a.y=this.maxHp.y-10,a.width=100,a.size=35,a.textColor=16724787,a.fontFamily="Colonna MT",a.stroke=2,a.strokeColor=16777215,this.addChild(a),this.damText.push(a)}},p.InitHM=function(){this.disHP=new egret.Bitmap,this.disHP.texture=RES.getRes("BATplayerHP"),this.disHP.x=110,this.disHP.y=140,this.disHP.fillMode=egret.BitmapFillMode.REPEAT,this.addChild(this.disHP),this.maxHp=new egret.Bitmap,this.maxHp.texture=RES.getRes("BATplayerMHP"),this.maxHp.width=this.disHP.width,this.maxHp.x=this.disHP.x,this.maxHp.y=this.disHP.y,this.addChild(this.maxHp),this.HPnum=new egret.TextField,this.HPnum.fontFamily="Colonna MT",this.HPnum.text=this._curhp+"/"+this._maxhp,this.HPnum.x=this.maxHp.x+this.maxHp.width-120,this.HPnum.y=this.maxHp.y,this.HPnum.size=35,this.HPnum.stroke=1,this.HPnum.strokeColor=11145489,this.HPnum.textColor=16777215,this.addChild(this.HPnum),this.disMP=new egret.Bitmap,this.disMP.texture=RES.getRes("BATplayerMP"),this.disMP.x=this.disHP.x-65,this.disMP.y=this.disHP.y-100+30,this.disMP.fillMode=egret.BitmapFillMode.REPEAT,this.addChild(this.disMP),this.maxMP=new egret.Bitmap,this.maxMP.texture=RES.getRes("BATplayerMMP"),this.maxMP.x=this.disMP.x,this.maxMP.y=this.disMP.y,this.addChild(this.maxMP),this.MPnum=new egret.TextField,this.MPnum.fontFamily="Colonna MT",this.MPnum.text=this._curmp.toFixed(0),this.MPnum.x=this.maxMP.x+this.MPnum.measuredWidth/2+55,this.MPnum.anchorOffsetX=this.MPnum.measuredWidth,this.MPnum.y=this.maxMP.y+40,this.MPnum.size=50,this.MPnum.stroke=2,this.MPnum.textColor=16777215,this.addChild(this.MPnum),this.MPnumMax.text="/"+this._maxmp.toFixed(0),this.MPnumMax.fontFamily="方正古隶简体",this.MPnumMax.x=this.MPnum.x,this.MPnumMax.y=this.maxMP.y+40,this.MPnumMax.size=30,this.MPnumMax.stroke=2,this.MPnumMax.textColor=16777215,this.addChild(this.MPnumMax),this.cureHP.texture=RES.getRes("BATplayerHP"),this.cureHP.x=110,this.cureHP.y=140,this.cureHP.fillMode=egret.BitmapFillMode.REPEAT,this.cureHP.alpha=.5,this.cureHP.width=0,this.addChildAt(this.cureHP,this.getChildIndex(this.disHP)-1),this.cureText.x=this.maxHp.x+this.maxHp.width+10,this.cureText.fontFamily="Colonna MT",this.cureText.y=this.maxHp.y,this.cureText.size=35,this.cureText.stroke=2,this.cureText.strokeColor=1157649,this.addChild(this.cureText),this.updateMP()},p.tapIcon=function(t){var e=t.target.gid;this._curmp-=this.dataRole[e]._skillcost,this._curmp<0?this._curmp+=this.dataRole[e]._skillcost:(this.dispatchEvent(new egret.Event(GameEvent.STOP_BATTLE_PROC)),this.playSkillAni(this.dataRole[e]._name,this.dataRole[e]._skillname)),this.updateMP()},p.Move=function(){return this.speedcount>=BattleMain.PSpeedCount?(this.speedcount=0,!0):(this.speedcount+=.001*this._speed*this.status[1].Number,!1)},p.Damage=function(t){this._curhp<=0||(this._curhp-=t*this.status[0].Number,this._curhp>0?(t>=0&&this.DamageAni(t),this.updateHP()):(this._isDead=!0,this.disHP.width=0,this.dispatchEvent(new egret.Event("Player die"))))},p.Cure=function(t){this._curhp+=t*this._cure/3,this._curhp>this._maxhp&&(this._curhp=this._maxhp),this.updateHP(),this.CurAni()},p.CurAni=function(){},p.DamageAni=function(t){egret.Tween.get(this).to({y:this.y},250,egret.Ease.bounceInOut).to({y:this.y+10},50,egret.Ease.bounceInOut).to({y:this.y-10},50,egret.Ease.bounceInOut).to({y:this.y+5},50,egret.Ease.bounceInOut).to({y:this.y-5},50,egret.Ease.bounceInOut).to({y:this.y},50,egret.Ease.bounceInOut);for(var e=0,i=0;i<this.damText.length;i++){if(100==this.damText[i].width){this.damText[i].width=200,this.damText[i].alpha=1,this.damText[i].text="-"+t.toFixed(0),egret.Tween.get(this.damText[i]).to({},e).to({y:this.damText[i].y-30},450).to({y:this.damText[i].y,alpha:0,width:100},20);break}e+=100}},p.getRelativeSC=function(){return this.speedcount/BattleMain.PSpeedCount},p.resetCount=function(){this.speedcount=0},p.updateHP=function(){this.disHP.width=this._curhp/this._maxhp*this.maxHp.width,this.HPnum.text=this._curhp.toFixed(0)+"/"+this._maxhp.toFixed(0)},p.addMP=function(t){this._curmp+=t.data,this._curmp>this._maxmp&&(this._curmp=this._maxmp),this.updateMP()},p.updateMP=function(){this.mpMask.y=(1-this._curmp/this._maxmp)*this.maxMP.height,this.MPnum.text=this._curmp.toFixed(0),this.MPnum.anchorOffsetX=this.MPnum.measuredWidth,this.disMP.mask=this.mpMask},p.AttackAni=function(){for(var t=0;t<this.disRole.length;t++)this.atkData[t]=this.tarData[t],egret.Tween.get(this.disRole[t]).to({x:this.disRole[t].x+10},250).to({x:this.disRole[t].x},250).call(this.endAtk,this).to({},500).call(this.aniover,this);this.updateAtkData()},p.aniover=function(){this.anicount++;var t=this.disRole.length;this.anicount==t&&(this.anicount=0,this.dispatchEvent(new egret.Event("attack over")))},p.AddStatus=function(t,e,i){this.status[i].addStatus(t,e),this.addChild(this.status[i])},p.AddAttack=function(t,e,i){for(var s=0;s<this.dataRole.length;s++)!this.dataRole[s]._haveCard||this.dataRole[s]._element!=i&&-1!=i||(this.dataRole[s]._sta.addStatus(t,e),this.addChild(this.dataRole[s]._sta))},p.strenGroup=function(t){for(var e=0;e<t._strengthen.length;e++)for(var i=t._strengthen[e]._number,s=0;s<this.dataRole.length;s++)if(this.dataRole[s]._haveCard&&(this.dataRole[s]._element==t._strengthen[e]._element||-1==t._strengthen[e]._element))switch(t._strengthen[e]._attribute){case"atk":this.dataRole[s]._attack*=i;break;case"cur":this._cure-=PlayerData._ownCards[this.dataRole[s]._pid]._cure,this._cure+=PlayerData._ownCards[this.dataRole[s]._pid]._cure*i;break;case"spd":this._speed-=PlayerData._ownCards[this.dataRole[s]._pid]._speed,this._speed+=PlayerData._ownCards[this.dataRole[s]._pid]._speed*i;break;case"hp":this._maxhp-=PlayerData._ownCards[this.dataRole[s]._pid]._hp,this._maxhp+=PlayerData._ownCards[this.dataRole[s]._pid]._hp*i,this._curhp=this._maxhp}this.updateHP()},p.UpdateStatus=function(){for(var t=0;t<this.status.length;t++)this.status[t].UpdateStatus();for(var t=0;t<this.dataRole.length;t++)this.dataRole[t]._haveCard&&this.dataRole[t]._sta.UpdateStatus()},p.updateTarData=function(t){for(var e=0;e<this.atkData.length;e++){var i=t[this.dataRole[e]._element];this.tarData[e]=this.dataRole[e].getAtk(i),this.dataRole[e]._haveCard||(this.tarData[e]=0)}this.tarCure=this._cure*t[0]/3},p.updateAtkData=function(){for(var t=0;t<this.atkData.length;t++)this.atkData[t]<this.tarData[t]&&(this.atkData[t]+=this.dataRole[t].AtkNum()/15,this.atkData[t]>this.tarData[t]&&(this.atkData[t]=this.tarData[t])),0==this.atkData[t]?this.atkText[t].text="":this.atkText[t].text=this.atkData[t].toFixed(0);(this._curhp+this.tarCure)/this._maxhp<1?this.cureHP.width=(this._curhp+this.tarCure)/this._maxhp*this.maxHp.width:this.cureHP.width=this.maxHp.width,0==this.tarCure||this._maxhp==this._curhp?this.cureText.text="":this.cureData<this.tarCure&&(this.cureData+=this._cure/15,this.cureData>this.tarCure&&(this.cureData=this.tarCure),this.cureText.text="+"+this.cureData.toFixed(0))},p.endAtk=function(){for(var t=0;t<this.atkData.length;t++)this.tarData[t]=0,this.atkData[t]=0,this.cureData=0,this.tarCure=0;this.updateAtkData()},p.CreateSkill=function(t){var e=SkillManage.CreateSkill(t);"NULL"!=e._name&&this.dispatchEvent(new egret.Event("Skill",!1,!1,e))},p.playSkillAni=function(t,e){var i=new egret.Bitmap;i.texture=RES.getRes(t+"Img"),i.alpha=0,i.x=100,i.y=50,this.addChild(i);var s=new egret.Bitmap;s.texture=RES.getRes("BATskillBack"),s.x=500,s.alpha=0,s.y=500,this.addChild(s);var a=new egret.TextField;a.text=e;var h=s.width/2-a.textWidth/2;a.x=s.x+h,a.y=s.y+7,a.fontFamily="微软雅黑",a.bold=!0,a.size=20,this.addChild(a),egret.Tween.get(i).to({x:400,alpha:1},500).to({x:420},1e3).to({x:520,alpha:0},500).call(function(){i.parent.removeChild(i)},this),egret.Tween.get(s).to({x:400,alpha:1},500).to({x:380},1e3).to({x:300,alpha:0},500).call(function(){s.parent.removeChild(s),this.CreateSkill(t),this.dispatchEvent(new egret.Event(GameEvent.CONTINUE_BATTLE))},this),egret.Tween.get(a).to({x:400+h,alpha:1},500).to({x:380+h},1e3).to({x:300+h,alpha:0},500).call(function(){a.parent.removeChild(a)},this)},e}(egret.DisplayObjectContainer);egret.registerClass(BattlePlayer,"BattlePlayer");var Enemy=function(t){function e(){t.call(this),this._isDead=!1,this.speedcount=0,this._lock=!1,this._watefordead=!0}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(t,e,i){var s=RES.getRes("ENM"+t+"_json");this._tname=s.name,this._maxhp=s.hp*e,this._curhp=this._maxhp,this._attack=s.attack*e,this._defense=s.defense,this._speed=s.speed,this._element=i,.001*this._speed>=BattleMain.PSpeedCount&&console.log("请修改公共speedcount上限--from enemy"),this.enemy=new egret.Bitmap,this.enemy.texture=RES.getRes("ENM"+this._tname+i.toString()),this.addChild(this.enemy),this.hp=new egret.Bitmap,this.hp.texture=RES.getRes("BATenemy_hp"),this.hp.y=.75*this.enemy.height,this.hp.x=.15*this.enemy.width,this.hp.fillMode=egret.BitmapFillMode.REPEAT,this.addChild(this.hp),this.mhp=new egret.Bitmap,this.mhp.texture=RES.getRes("BATenemy_mhp"),this.mhp.width=this.hp.width,this.mhp.y=this.hp.y,this.mhp.x=this.hp.x,this.addChild(this.mhp),this.hpnum=new egret.TextField,this.hpnum.text=this._curhp+"/"+this._maxhp,this.hpnum.size=30,this.hpnum.stroke=2,this.hpnum.fontFamily="Colonna MT",this.addChild(this.hpnum),this.hpnum.x=this.mhp.x+.55*this.mhp.width,this.hpnum.y=this.mhp.y-20,1==i?this.hpnum.strokeColor=4456448:2==i?this.hpnum.strokeColor=68:3==i?this.hpnum.strokeColor=17408:4==i?this.hpnum.strokeColor=4473856:5==i&&(this.hpnum.strokeColor=4456516)},p.Move=function(){return this._lock?void 0:this.speedcount>=BattleMain.PSpeedCount?(this.speedcount=0,!0):(this.speedcount+=.001*this._speed,!1)},p.getRelativeSC=function(){return this.speedcount/BattleMain.PSpeedCount},p.Attack=function(){return this.AttackAni(),this._attack},p.AttackAni=function(){egret.Tween.get(this).to({x:this.x-40},100,egret.Ease.backInOut).to({x:this.x-40},200).to({x:this.x},100)},p.Damage=function(t,e){if(!(this._curhp<=0)){var i=(t-this._defense)*this.testElement(e);this._curhp-=i,this._curhp<=0&&(this._curhp=0,this._isDead=!0),this.damageAni(t,e)}},p.dead=function(){this._isDead&&this._watefordead&&(this._watefordead=!1,this.playDeath())},p.damageAni=function(t,e){if(egret.Tween.get(this).to({y:this.y},350,egret.Ease.bounceInOut).to({y:this.y+10},50,egret.Ease.bounceInOut).to({y:this.y-10},50,egret.Ease.bounceInOut).call(this.setHP,this).to({y:this.y+5},50,egret.Ease.bounceInOut).to({y:this.y-5},50,egret.Ease.bounceInOut).to({y:this.y},50,egret.Ease.bounceInOut).call(this.dead,this),0!=t){var i=new egret.TextField;this.addChild(i),i.text=t.toFixed(0),i.fontFamily="Stencil",i.stroke=2,i.alpha=0,1==e?i.textColor=16711680:2==e?i.textColor=255:3==e?i.textColor=65280:4==e?i.textColor=16776960:5==e&&(i.textColor=5570815),1==this.testElement(e)?i.size=25:.5==this.testElement(e)&&(i.size=20),i.x=Math.random()*(this.mhp.x+this.mhp.width),i.y=this.mhp.y,egret.Tween.get(i).to({},350).to({alpha:1}).to({y:i.y-30},1e3).call(function(){null!=i.parent&&i.parent.removeChild(i)},this)}},p.setHP=function(){this.hp.width=this._curhp/this._maxhp*this.mhp.width,this.hpnum.text=this._curhp.toFixed(0)+"/"+this._maxhp},p.playDeath=function(){egret.Tween.get(this.enemy).to({alpha:0},400),egret.Tween.get(this.hp).to({alpha:0},400),egret.Tween.get(this.mhp).to({alpha:0},400).call(this.removeChildren,this)},p.back=function(t){this.speedcount-=t,this._lock=!0,this.speedcount<0&&(this.speedcount=0)},p.unlock=function(){this._lock=!1},p.testElement=function(t){if(4>t&&this._element<4){if((this._element+1)%3==t%3)return 1.5;if((this._element-1)%3==t%3)return.5}else if(t>=4&&this._element>=4)return this._element!=t?1.5:1;return 1},e}(egret.DisplayObjectContainer);egret.registerClass(Enemy,"Enemy");var LStrengthen=function(){function t(){}var e=(__define,t);return p=e.prototype,t}();egret.registerClass(LStrengthen,"LStrengthen");var LSkillData=function(){function t(t){this._strengthen=[],this._name=t}var e=(__define,t);return p=e.prototype,p.addDescribe=function(t,e,i){var s=new LStrengthen;s._element=t,s._attribute=e,s._number=i,this._strengthen.push(s)},p.addMutiDesByEle=function(t,e,i){for(var s=0;s<t.length;s++)this.addDescribe(t[s],e,i)},t}();egret.registerClass(LSkillData,"LSkillData");var SkillData=function(){function t(t,e,i){this._name=t,this._val1=e,this._val2=i}var e=(__define,t);return p=e.prototype,t}();egret.registerClass(SkillData,"SkillData");var SkillManage=function(){function t(){}var e=(__define,t);return p=e.prototype,t.CreateSkill=function(t){var e;switch(t){case"Karine":e=new SkillData("BackTimeLine",20,1);break;case"Savino":e=new SkillData("Cure",3,-1);break;case"Lance":e=new SkillData("Strenthen",3,2),e._val3=-1;break;case"Lokia":e=new SkillData("AddColor",5,.7),e._val3=3;break;case"Mobius":e=new SkillData("Change",2,4);break;case"Izv":e=new SkillData("AddStatus",0,1),e._val3=0;break;case"Blank":e=new SkillData("Change",4,5);break;case"Costilla":e=new SkillData("Change",3,2);break;case"Tatragon":e=new SkillData("AddStatus",2,3),e._val3=1;break;case"Arise":e=new SkillData("AddStatus",.9,5),e._val3=0;break;case"Blunt":e=new SkillData("BackTimeLine",90,0);break;case"Wheel":e=new SkillData("AddColor",4,.5),e._val3=3;break;default:e=new SkillData("NULL",-1,-1)}return e},t.CreateLeaderSkill=function(t){var e;switch(t){case"Karine":e=new LSkillData("STREN"),e.addDescribe(-1,"atk",1.5);break;case"Savino":e=new LSkillData("STREN"),e.addDescribe(-1,"hp",1.1),e.addDescribe(-1,"cur",1.5);break;case"Lance":e=new LSkillData("STREN"),e.addDescribe(-1,"spd",1.5);break;case"Lokia":e=new LSkillData("COLOR"),e.addDescribe(5,"null",9),e._val1=3;break;case"Mobius":e=new LSkillData("STREN"),e.addDescribe(4,"hp",1.3),e.addDescribe(4,"atk",1.5);break;case"Izv":e=new LSkillData("STREN"),e.addDescribe(3,"hp",2),e.addDescribe(3,"cur",2);break;case"Blank":e=new LSkillData("STREN"),e.addDescribe(1,"atk",1.5),e.addDescribe(5,"hp",1.2);break;case"Costilla":e=new LSkillData("STREN"),e.addDescribe(2,"atk",2);break;case"Tatragon":e=new LSkillData("STREN"),e.addDescribe(3,"atk",1.5),e.addDescribe(3,"spd",1.2);break;case"Arise":e=new LSkillData("STREN"),e.addDescribe(2,"hp",1.2),e.addDescribe(2,"atk",1.2);break;case"Blunt":e=new LSkillData("STREN"),e.addDescribe(1,"atk",1.5);break;case"Wheel":e=new LSkillData("STREN"),e.addDescribe(4,"atk",1.5);break;default:e=new LSkillData("NULL")}return e},t}();egret.registerClass(SkillManage,"SkillManage");var Status=function(t){function e(e){t.call(this),this.leftTurns=0,this.Number=1,this.typeMark=new egret.Bitmap,this.left=new egret.TextField,this.element=6,this.Init(e)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(t){switch(this.type=t,this.typeMark.texture=RES.getRes("BAT"+this.type),this.left.size=20,this.left.bold=!0,this.left.x=33,this.left.y=7,this.type){case"attack":this.left.textColor=16711680;break;case"defense":this.left.textColor=255;break;case"speed":this.left.textColor=65280;break;case"color":this.left.textColor=16777215}},p.addStatus=function(t,e){this.Number=t,this.leftTurns=e,6!=this.element&&(this.typeMark.texture=RES.getRes("BAT"+this.type+this.element.toFixed(0))),this.addChild(this.typeMark),this.addChild(this.left),this.UpdateLeftShow()},p.UpdateStatus=function(){this.leftTurns>0&&this.leftTurns--,this.leftTurns<=0&&(this.Number=1),this.UpdateLeftShow()},p.UpdateLeftShow=function(){this.leftTurns>0?this.left.text=this.leftTurns.toString():(this.left.text="",null!=this.typeMark.parent&&this.removeChild(this.typeMark))},e}(egret.DisplayObjectContainer);egret.registerClass(Status,"Status");var Ball=function(t){function e(){t.call(this),this._timer=new egret.Timer(20)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(t){switch(this.element=t,this.alpha=1,t){case 0:this.texture=RES.getRes("BATheart");break;case 1:this.texture=RES.getRes("BATfire");break;case 2:this.texture=RES.getRes("BATwater");break;case 3:this.texture=RES.getRes("BATwind");break;case 4:this.texture=RES.getRes("BATearth");break;case 5:this.texture=RES.getRes("BATthunder");break;default:this.texture=null}this.width=e.ballsize,this.height=e.ballsize},p.clear=function(){egret.Tween.get(this).to({alpha:0},200).call(this.aniover)},p.aniover=function(){this.Init(-1),this.dispatchEvent(new egret.Event("ball has been cleared"))},e.ballsize=80,e}(egret.Bitmap);egret.registerClass(Ball,"Ball");var DamageSys=function(t){function e(){t.call(this),this._selectMark=new egret.Bitmap,this.banTouch=new egret.Bitmap,this.myMask=new egret.Rectangle(383,169,515,512),this._elements=[0,0,0,0,0,0],this._combo=0,this.actover=!1,this.timeout=!1,this.anicount=0,this.chaincount=0,this.ballcount=0,this.statusE=-1,this.statusC=new Status("color"),this.skillLock=!1,this.Init()}__extends(e,t);var i=(__define,e);return p=i.prototype,p.minusBall=function(){if(this.ballcount--,this.ballcount<=0){for(var t=0;6>t;t++)this._diplayMap[t][this.chaincount].removeEventListener("ball has been cleared",this.minusBall,this);this.chaincount--,this.clear(),this._timelimit.Recover()}},p.Init=function(){this.mask=this.myMask,this.statusC.x=285,this.statusC.y=113;var t=new egret.Bitmap;this.addChild(t),t.alpha=.9,t.texture=RES.getRes("BATballMapBG"),t.touchEnabled=!0,this.banTouch.texture=RES.getRes("MAINblack"),this.banTouch.alpha=.5,this.banTouch.width=500,this.banTouch.height=500,this.banTouch.x=394,this.banTouch.y=181,this._timelimit=new TimeLimit,this._timelimit.x=382,this._timelimit.y=180,this.addChild(this._timelimit),this._diplayMap=[],this._logicMap=[],this._virtualBall=[],this._tempC=new egret.DisplayObjectContainer;for(var i=0;6>i;i++){for(var s=[],a=[],h=0;6>h;h++){var r=new Ball;r.x=e.leftboarder+h*Ball.ballsize,r.y=e.upboarder+i*Ball.ballsize,r.touchEnabled=!0,r.addEventListener(egret.TouchEvent.TOUCH_TAP,this.getTouch,this),r.ballx=i,r.bally=h,this.addChild(r),s.push(r),a.push(-1)}this._diplayMap.push(s),this._logicMap.push(a)}for(var i=0;6>i;i++){var r=new Ball;this._virtualBall.push(r)}this._mask=new egret.Bitmap,this._mask.texture=RES.getRes("BATmask"),this.addChild(this._mask),this.ResetMap(),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.getMapTap,this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.added,this),this._timelimit.addEventListener("time out!",this.TimeOut,this),this.addChild(this._selectMark),this._selectMark.texture=RES.getRes("BATballselect1"),this._selectMark.anchorOffsetX=this._selectMark.width/2,this._selectMark.anchorOffsetY=this._selectMark.height/2,this.updateSelect()},p.added=function(){this.playSelect()},p.playSelect=function(){null!=this.stage&&(0==this._selectMark.rotation?egret.Tween.get(this._selectMark).to({rotation:360},4e3).call(this.playSelect,this):(this._selectMark.rotation=0,this.playSelect()))},p.TimeOut=function(){this.timeout=!0,this.statusC.leftTurns>0&&(this.statusC.leftTurns--,this.statusC.leftTurns<=0&&(this.statusC.leftTurns=0,this.statusC.Number=0,this.statusE=-1)),this.statusC.UpdateLeftShow(),0!=this.touchChildren&&(this.CheckChain(),this._selBallx=-1,this._selBally=-1,this.updateSelect())},p.getMapTap=function(){this._timelimit.startTime(),this.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.getMapTap,this)},p.ResetMap=function(){for(var t=0;6>t;t++)for(var e=0;6>e;e++){var i=Math.floor(6*Math.random());
if(0!=e)for(;i==this._logicMap[t][e-1];)i=Math.floor(6*Math.random());if(t>1)for(;i==this._logicMap[t-1][e]&&i==this._logicMap[t-2][e];)i=Math.floor(6*Math.random());this._diplayMap[t][e].Init(i),this._logicMap[t][e]=i}this._selBallx=-1,this._selBally=-1},p.getTouch=function(t){if(-1==this._selBallx&&-1==this._selBally)this._selBallx=t.target.ballx,this._selBally=t.target.bally,this.updateSelect();else if(this._selBallx==t.target.ballx&&this._selBally==t.target.bally)this._selBallx=-1,this._selBally=-1,this.updateSelect();else if(this._selBallx==t.target.ballx){var e=t.target.bally-this._selBally,i=[0,0,0,0,0,0];this._selectMark.visible=!1;for(var s=0;6>s;s++){var a=this._logicMap[this._selBallx][s],h=(s+e+6)%6;i[h]=a}for(var s=0;6>s;s++)this._logicMap[this._selBallx][s]=i[s];this.playMove(e,"hang",this._selBallx)}else if(this._selBally==t.target.bally){var e=t.target.ballx-this._selBallx,i=[0,0,0,0,0,0];this._selectMark.visible=!1;for(var s=0;6>s;s++){var a=this._logicMap[s][this._selBally],h=(s+e+6)%6;i[h]=a}for(var s=0;6>s;s++)this._logicMap[s][this._selBally]=i[s];this.playMove(e,"lie",this._selBally)}else this._selBallx=t.target.ballx,this._selBally=t.target.bally,this.updateSelect()},p.updateSelect=function(){-1==this._selBallx&&-1==this._selBally?this._selectMark.visible=!1:(this._selectMark.visible=!0,this._selectMark.x=this._diplayMap[this._selBallx][this._selBally].x+40,this._selectMark.y=this._diplayMap[this._selBallx][this._selBally].y+40,this._selectMark.texture=RES.getRes("BATballselect"+this._diplayMap[this._selBallx][this._selBally].element.toString()))},p.playMove=function(t,e,i){if(this.touchChildren=!1,"hang"==e&&0>t){this.addChildAt(this._tempC,this.getChildIndex(this._mask)-1);for(var s=0;6>s;s++)this._virtualBall[s].x=this._diplayMap[i][s].x+6*Ball.ballsize,this._virtualBall[s].y=this._diplayMap[i][s].y,this._virtualBall[s].Init(this._diplayMap[i][s].element),this._tempC.addChild(this._diplayMap[i][s]),this._tempC.addChild(this._virtualBall[s]);egret.Tween.get(this._tempC).to({x:this._tempC.x+t*Ball.ballsize},70*Math.abs(t)).call(this.MoveOver,this)}if("hang"==e&&t>0){this.addChildAt(this._tempC,this.getChildIndex(this._mask)-1);for(var s=0;6>s;s++)this._virtualBall[s].x=this._diplayMap[i][s].x-6*Ball.ballsize,this._virtualBall[s].y=this._diplayMap[i][s].y,this._virtualBall[s].Init(this._diplayMap[i][s].element),this._tempC.addChild(this._diplayMap[i][s]),this._tempC.addChild(this._virtualBall[s]);egret.Tween.get(this._tempC).to({x:this._tempC.x+t*Ball.ballsize},70*Math.abs(t)).call(this.MoveOver,this)}if("lie"==e&&0>t){this.addChildAt(this._tempC,this.getChildIndex(this._mask)-1);for(var s=0;6>s;s++)this._virtualBall[s].x=this._diplayMap[s][i].x,this._virtualBall[s].y=this._diplayMap[s][i].y+6*Ball.ballsize,this._virtualBall[s].Init(this._diplayMap[s][i].element),this._tempC.addChild(this._diplayMap[s][i]),this._tempC.addChild(this._virtualBall[s]);egret.Tween.get(this._tempC).to({y:this._tempC.y+t*Ball.ballsize},70*Math.abs(t)).call(this.MoveOver,this)}if("lie"==e&&t>0){this.addChildAt(this._tempC,this.getChildIndex(this._mask)-1);for(var s=0;6>s;s++)this._virtualBall[s].x=this._diplayMap[s][i].x,this._virtualBall[s].y=this._diplayMap[s][i].y-6*Ball.ballsize,this._virtualBall[s].Init(this._diplayMap[s][i].element),this._tempC.addChild(this._diplayMap[s][i]),this._tempC.addChild(this._virtualBall[s]);egret.Tween.get(this._tempC).to({y:this._tempC.y+t*Ball.ballsize},70*Math.abs(t)).call(this.MoveOver,this)}},p.MoveOver=function(){this.SetDisToLogic(),this.CheckChain()},p.SetDisToLogic=function(){this._tempC.x=0,this._tempC.y=0,this._tempC.removeChildren(),null!=this._tempC.parent&&this.removeChild(this._tempC);for(var t=0;6>t;t++)for(var e=0;6>e;e++)this._diplayMap[t][e].Init(this._logicMap[t][e]),this.addChildAt(this._diplayMap[t][e],this.getChildIndex(this._mask)-1);this._selBallx=-1,this._selBally=-1,this.updateSelect()},p.CheckChain=function(){this.touchChildren=!1,this._timelimit.stopTime();for(var t=!0,e=[[-1,-1,-1,-1,-1,-1],[-1,-1,-1,-1,-1,-1],[-1,-1,-1,-1,-1,-1],[-1,-1,-1,-1,-1,-1],[-1,-1,-1,-1,-1,-1],[-1,-1,-1,-1,-1,-1]],i=0;6>i;i++)for(var s=0;6>s;s++)4>s&&this._logicMap[i][s]==this._logicMap[i][s+1]&&this._logicMap[i][s]==this._logicMap[i][s+2]&&(e[i][s]=this._logicMap[i][s],e[i][s+1]=this._logicMap[i][s],e[i][s+2]=this._logicMap[i][s],t=!1),4>i&&this._logicMap[i][s]==this._logicMap[i+1][s]&&this._logicMap[i][s]==this._logicMap[i+2][s]&&(e[i][s]=e[i][s]=this._logicMap[i][s],e[i+1][s]=e[i][s]=this._logicMap[i][s],e[i+2][s]=e[i][s]=this._logicMap[i][s],t=!1);if(t)return this._timelimit.getCurTime()>0&&(this.timeout=!1),void(this.timeout?(this.addChild(this.banTouch),this.dispatchEvent(new egret.Event("actover")),this.actover=!0):(this.touchChildren=!0,this.skillLock||this._timelimit.startTime()));this.chaingroup=[];for(var a,h,i=0;6>i;i++)for(var s=0;6>s;s++)if(-1!=e[i][s]&&6!=e[i][s]){var r=[],n=[],o=new egret.Point(i,s);for(r.push(o);0!=r.length;)a=r[r.length-1].x,h=r[r.length-1].y,6!=e[a][h]?(n.push(r[r.length-1]),r.pop(),0!=a&&e[a][h]==e[a-1][h]&&r.push(new egret.Point(a-1,h)),5!=a&&e[a][h]==e[a+1][h]&&r.push(new egret.Point(a+1,h)),0!=h&&e[a][h]==e[a][h-1]&&r.push(new egret.Point(a,h-1)),5!=h&&e[a][h]==e[a][h+1]&&r.push(new egret.Point(a,h+1)),e[a][h]=6):r.pop();this.chaingroup.push(n)}this.chaincount=this.chaingroup.length-1,this.clear()},p.clear=function(){if(this.chaincount<=-1)return void this.addBall();var t=this.chaincount;this.ballcount=this.chaingroup[t].length,0!=this.chaingroup[t].length&&(this._combo++,this.dispatchEvent(new egret.Event("add MP",!1,!1,this.chaingroup[t].length)));for(var e=0;e<this.chaingroup[t].length;e++)this._elements[this._logicMap[this.chaingroup[t][e].x][this.chaingroup[t][e].y]]++,this._logicMap[this.chaingroup[t][e].x][this.chaingroup[t][e].y]=-1,this._diplayMap[this.chaingroup[t][e].x][this.chaingroup[t][e].y].addEventListener("ball has been cleared",this.minusBall,this),this._diplayMap[this.chaingroup[t][e].x][this.chaingroup[t][e].y].clear();this.dispatchEvent(new egret.Event(GameEvent.CHAIN_OVER))},p.addBall=function(){for(var t=0;6>t;t++){for(var i=[],s=5;s>=0;s--)-1!=this._logicMap[s][t]&&i.push(this._logicMap[s][t]);for(var s=i.length;6>s;s++){var a=this.CreatebyChance();i.push(a)}for(var s=5;s>=0;s--)this._logicMap[s][t]=i[5-s]}for(var t=0;6>t;t++)for(var s=5;s>=0;s--)if(-1==this._diplayMap[s][t].element){for(var h=!0,r=s-1;r>=0;r--)if(-1!=this._diplayMap[r][t].element){h=!1,this._diplayMap[s][t].y=this._diplayMap[r][t].y,this._diplayMap[r][t].Init(-1);break}if(h){for(var r=s;r>=0;r--)this._diplayMap[r][t].y-=Ball.ballsize*(s+1);break}}this.SetDisToLogic(),this.anicount=0;for(var s=0;6>s;s++)for(var t=0;6>t;t++)egret.Tween.get(this._diplayMap[s][t]).to({y:e.upboarder+s*Ball.ballsize},400,egret.Ease.circOut).call(this.aniover,this)},p.aniover=function(){this.anicount++,36==this.anicount&&this.CheckChain()},p.readyAction=function(){this.touchChildren=!0;for(var t=0;t<this._elements.length;t++)this._elements[t]=0;this._combo=0,this.timeout=!1,this.actover=!1,null!=this.banTouch.parent&&this.removeChild(this.banTouch),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.getMapTap,this),this._timelimit.Reset()},p.Change=function(t,e){for(var i=0;6>i;i++)for(var s=0;6>s;s++)this._logicMap[i][s]==t&&(this._logicMap[i][s]=e,this._diplayMap[i][s].Init(e))},p.CreatebyChance=function(){if(-1==this.statusE)return Math.floor(6*Math.random());var t=Math.random();if(t<this.statusC.Number)return this.statusE;for(t=Math.floor(6*Math.random());t==this.statusE;)t=Math.floor(6*Math.random());return t},p.AddColor=function(t,e,i){0==this.statusC.leftTurns&&(this.statusE=t,this.statusC.element=t,this.statusC.addStatus(e,i))},p.calcuCombo=function(){if(0!=this._combo){for(var t=0;t<this._elements.length;t++)this._elements[t]*=1+.1*(this._combo-1);this._combo=0}},p.applyLSkill=function(t){for(var e=0;e<t._strengthen.length;e++){var i=this._elements[t._strengthen[e]._element];if(i<t._strengthen[e]._number)return!1}return!0},p.pause=function(t){t?(this._timelimit.stopTime(),this.touchChildren=!1,this.addChild(this.banTouch)):(this._timelimit.startTime(),this.touchChildren=!0,null!=this.banTouch.parent&&this.removeChild(this.banTouch))},e.upboarder=185,e.leftboarder=400,e}(egret.DisplayObjectContainer);egret.registerClass(DamageSys,"DamageSys");var TimeLimit=function(t){function e(){t.call(this),this.maxtime=250,this.curtime=250,this._timer=new egret.Timer(20),this.Init()}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(){this.showtime=new egret.Bitmap,this.showtime.texture=RES.getRes("BATtime"),this.showtime.fillMode=egret.BitmapFillMode.REPEAT,this.myMask=new egret.Rectangle(0,0,this.showtime.width,this.showtime.height),this.showtime.mask=this.myMask,this.showtime.scaleX=.98,this.showtime.x=5,this.showtime.scaleY=.99,this.showtime.y=5,this.addChild(this.showtime),this.showtimeback=new egret.Bitmap,this.showtimeback.texture=RES.getRes("BATtime"),this._timer.addEventListener(egret.TimerEvent.TIMER,this.update,this)},p.Recover=function(){this.curtime>0&&(this.curtime+=5,this.curtime>this.maxtime&&(this.curtime=this.maxtime),this.setDis())},p.stopTime=function(){this._timer.stop(),this._timer.reset()},p.startTime=function(){this._timer.start()},p.update=function(){this.curtime--,this.setDis(),this.curtime<=0&&(this.dispatchEvent(new egret.Event("time out!")),this.stopTime())},p.Reset=function(){this.curtime=this.maxtime,this.setDis()},p.setDis=function(){this.myMask.y=(1-this.curtime/this.maxtime)*this.showtimeback.height,this.showtime.mask=this.myMask},p.getCurTime=function(){return this.curtime},e}(egret.DisplayObjectContainer);egret.registerClass(TimeLimit,"TimeLimit");var Adventure=function(t){function e(){t.call(this),this.seLevel="",this.levels=new egret.DisplayObjectContainer,this.Init()}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(){this.addEventListener(egret.Event.ADDED_TO_STAGE,this.levelOver,this),this.back_to_main=new egret.Bitmap,this.back_to_main.texture=RES.getRes("back_to_map"),this.back_to_main.touchEnabled=!0,this.back_to_main.x=SystemData.stgX-this.back_to_main.width-20,this.back_to_main.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){this.back_to_main.texture=RES.getRes("back_to_map1")},this),this.back_to_main.addEventListener(egret.TouchEvent.TOUCH_END,this.backtoMain,this),this.back_to_main.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,function(){this.back_to_main.texture=RES.getRes("back_to_map")},this),this.start_lev=new egret.Bitmap,this.start_lev.texture=RES.getRes("startlev"),this.start_lev.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){this.start_lev.texture=RES.getRes("startlev1")},this),this.start_lev.addEventListener(egret.TouchEvent.TOUCH_END,this.startLev,this),this.start_lev.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,function(){this.start_lev.texture=RES.getRes("startlev")},this),this.start_lev.x=SystemData.stgX/2-200-this.start_lev.width/2,this.start_lev.y=600,this.start_lev.touchEnabled=!0,this.back_to_map=new egret.Bitmap,this.back_to_map.texture=RES.getRes("back_to_map"),this.back_to_map.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){this.back_to_map.texture=RES.getRes("back_to_map1")},this),this.back_to_map.addEventListener(egret.TouchEvent.TOUCH_END,this.backtoMap,this),this.back_to_map.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,function(){this.back_to_map.texture=RES.getRes("back_to_map")},this),this.back_to_map.x=SystemData.stgX/2+200-this.back_to_map.width/2,this.back_to_map.y=600,this.back_to_map.touchEnabled=!0,this.Lev=new LevelManage},p.InitMap=function(){for(var t=0;t<PlayerData._maplock.length;t++)for(var e=0;e<PlayerData._maplock[t].length;e++)if(PlayerData._maplock[t][e]){var i=RES.getRes("MapData_json"),s=new egret.Bitmap;s.name=i.levels[t][e].name,0==e?s.texture=RES.getRes((t+1).toString()+"-1"):s.texture=RES.getRes("NormalLev"),s.x=i.levels[t][e].x,s.y=i.levels[t][e].y,s.anchorOffsetX=s.width/2,s.anchorOffsetY=s.height/2,s.touchEnabled=!0,s.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTap,this),s.addEventListener(egret.Event.REMOVED,this.removeLev,this),this.levels.addChild(s)}for(var t=0;t<PlayerData._extraLev.length;t++)for(var e=0;e<PlayerData._extraLev.length;e++)if(PlayerData._extraLev[t][e]){var i=RES.getRes("MapData_json"),s=new egret.Bitmap;s.name=i.clevels[t][e].name,s.x=i.clevels[t][e].x,s.y=i.clevels[t][e].y,s.touchEnabled=!0,s.texture=RES.getRes("NormalLev"),s.anchorOffsetX=s.width/2,s.anchorOffsetY=s.height/2,s.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTap,this),s.addEventListener(egret.Event.REMOVED,this.removeLev,this),this.levels.addChild(s)}},p.removeLev=function(t){t.target.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onTap,this),t.target.removeEventListener(egret.Event.REMOVED_FROM_STAGE,this.removeLev,this)},p.onTap=function(t){this.seLevel=t.target.name,this.ChooseGroup()},p.ChooseGroup=function(){this.curgroup=new CardGroup(0),this.curgroup.touchChildren=!1,this.curgroup.x=SystemData.stgX/2-SystemData.groupWidth/2,this.curgroup.y=130,this.addChild(this.curgroup),this.addChild(this.start_lev),this.addChild(this.back_to_map),this.levels.touchChildren=!1,this.back_to_main.touchEnabled=!1},p.startLev=function(){if(this.start_lev.texture=RES.getRes("startlev"),this.curgroup.haveLeader()){console.log(this.seLevel);var t=RES.getRes(this.seLevel+"_json"),e=t.energy;PlayerData.cur_energy-e<0||(PlayerData.cur_energy-=e,this.Lev=new LevelManage,this.Lev.Init(this.seLevel,this.curgroup.gid),this.addChild(this.Lev),this.Lev.addEventListener(GameEvent.BACK_FROM_BAT_MAP,this.levelOver,this))}},p.backtoMap=function(){this.back_to_map.texture=RES.getRes("back_to_map"),this.removeChild(this.curgroup),this.removeChild(this.start_lev),this.removeChild(this.back_to_map),this.seLevel="",this.levels.touchChildren=!0,this.back_to_main.touchEnabled=!0},p.levelOver=function(){this.Lev.removeEventListener(GameEvent.BACK_FROM_BAT_MAP,this.levelOver,this),this.removeChildren();var t=new egret.Bitmap;t.texture=RES.getRes("WorldMap"),this.addChild(t),this.addChild(this.levels),this.levels.removeChildren(),this.InitMap(),this.levels.touchChildren=!0,this.addChild(this.back_to_main),this.back_to_main.touchEnabled=!0},p.backtoMain=function(){this.back_to_main.texture=RES.getRes("back_to_map");var t=new egret.Event(GameEvent.BACK_FROM_ADV);this.dispatchEvent(t)},e}(egret.DisplayObjectContainer);egret.registerClass(Adventure,"Adventure");var EditGroup=function(t){function e(){t.call(this),this.displayHave=new egret.ScrollView,this.havebg=new egret.Bitmap,this.allCards=[],this.cardGroup=[],this.curGroup=0,this.curCard=-1,this.showInfo=new egret.Bitmap,this.chooseBut=new egret.Bitmap,this.Init()}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(){var t=new egret.Bitmap;t.texture=RES.getRes("MainBG"),t.width=SystemData.stgX,t.height=SystemData.stgY,this.addChild(t),this.havebg.texture=RES.getRes("BoxBG"),this.havebg.x=0,this.havebg.y=0,this.addChild(this.havebg),this.displayHave.x=this.havebg.x+73,this.displayHave.y=this.havebg.y+55,this.displayHave.width=910,this.displayHave.height=180,this.addChild(this.displayHave),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.added,this),this.addEventListener(egret.Event.REMOVED_FROM_STAGE,this.removed,this),this.showInfo.texture=RES.getRes("showInfo"),this.showInfo.touchEnabled=!0,this.addChild(this.showInfo),this.showInfo.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){this.showInfo.texture=RES.getRes("showInfo1")},this),this.showInfo.addEventListener(egret.TouchEvent.TOUCH_TAP,this.ShowInfo,this),this.showInfo.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,function(){this.showInfo.texture=RES.getRes("showInfo")},this),this.showInfo.x=this.havebg.x+this.havebg.width-25,this.showInfo.y=480,this.chooseBut.texture=RES.getRes("MAINchoose"),this.chooseBut.touchEnabled=!0,this.chooseBut.pixelHitTest=!0,this.showInfo.addEventListener(egret.TouchEvent.TOUCH_TAP,this.ShowInfo,this)},p.displayCards=function(){this.displayHave.removeContent();for(var t=new egret.DisplayObjectContainer,e=0,i=0,s=0;s<PlayerData._ownCards.length;s++){var a=new DisplayCard;a.SetContent(s,"icong"),a.x=i,a.y=e,i+=SystemData.wCardH+10,i>=this.displayHave.width-80&&(i=0,e+=SystemData.wCardH+10),this.allCards.push(a),t.addChild(a),a.addEventListener(egret.TouchEvent.TOUCH_TAP,this.TapOnCard,this)}this.displayHave.setContent(t),this.disContent=t},p.added=function(){this.displayCards();for(var t=0;t<this.cardGroup.length;t++)null!=this.cardGroup[t].parent&&this.removeChild(this.cardGroup[t]);this.cardGroup=[];for(var t=0;4>t;t++){var e=new CardGroup(t);this.cardGroup.push(e),e.x=57,e.y=230}this.addChild(this.cardGroup[0]),this.curCard=-1,null!=this.chooseBut.parent&&this.chooseBut.parent.removeChild(this.chooseBut)},p.TapOnCard=function(t){-1!=this.cardGroup[this.curGroup]._curSelected&&(this.curCard=t.target.pid,this.cardGroup[this.curGroup].curGetID=this.curCard,this.chooseBut.x=t.target.x,this.chooseBut.y=t.target.y,this.cardGroup[this.curGroup].testAtri(t.target.pid),this.disContent.addChild(this.chooseBut),this.chooseBut.addEventListener(egret.TouchEvent.TOUCH_TAP,this.Choose,this))},p.Choose=function(){this.disContent.removeChild(this.chooseBut),this.cardGroup[this.curGroup].InputID(this.curCard),this.cardGroup[this.curGroup].curGetID=-1,this.curCard=-1},p.removed=function(){this.curGroup=0,PlayerData.UpdateLeader(),PlayerData.SaveData()},p.ShowInfo=function(){this.showInfo.texture=RES.getRes("showInfo");for(var t=0;t<this.cardGroup.length;t++)this.cardGroup[t].ShowInfo()},e}(egret.DisplayObjectContainer);egret.registerClass(EditGroup,"EditGroup");var Login=function(t){function e(){t.call(this),this.loadB=new egret.Bitmap,this.loadP=new egret.Bitmap,this.playername=new egret.TextField,this.Init()}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(){this.bg=new egret.Bitmap,this.bg.texture=RES.getRes("LoginBG"),this.bg.width=SystemData.stgX,this.bg.height=SystemData.stgY,this.addChild(this.bg),this.loadB.texture=RES.getRes("MAINloadingBack"),this.loadB.fillMode=egret.BitmapFillMode.REPEAT,this.loadB.x=494,this.loadB.y=454,this.addChild(this.loadB),this.loadP.texture=RES.getRes("MAINloadingPre"),this.loadP.x=this.loadB.x,this.loadP.y=this.loadB.y,this.addChild(this.loadP)},p.startGame=function(t){PlayerData.SetData(t.data,this)},p.activethis=function(){CardPool.Init(),this.bg.touchEnabled=!0,egret.Tween.get(this.loadB).to({alpha:0},500),egret.Tween.get(this.loadP).to({alpha:0},500).call(function(){this.showLog()},this)},p.setProgress=function(t,e){this.loadB.width=t/e*this.loadP.width},p.showLog=function(){var t=new Password;this.addChild(t),t.addEventListener(GameEvent.lOG_IN,this.startGame,this)},e}(egret.DisplayObjectContainer);egret.registerClass(Login,"Login");var MainUI=function(t){function e(){t.call(this),this.plv=new egret.TextField,this.pname=new egret.TextField,this.pexp=new egret.TextField,this.pexpM=new egret.TextField,this.penergy=new egret.TextField,this.penergyM=new egret.TextField,this.pdiamond=new egret.TextField,this.energyLine=new egret.Bitmap,this.expLine=new egret.Bitmap,this.leader=new egret.Bitmap,this.Init()}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(){var t=new egret.Bitmap;t.texture=RES.getRes("MainConBG"),t.width=SystemData.stgX,t.height=SystemData.stgY,this.addChild(t),this.addChild(this.leader),this.InitText(),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.UpdateStatus,this)},p.InitText=function(){this.addChild(this.energyLine),this.addChild(this.expLine),this.addChild(this.plv),this.addChild(this.pname),this.addChild(this.pexp),this.addChild(this.penergy),this.addChild(this.pdiamond),this.addChild(this.pexpM),this.addChild(this.penergyM),this.energyLine.texture=RES.getRes("APLine"),this.energyLine.x=760,this.energyLine.y=33,this.MaxApW=this.energyLine.width,this.expLine.texture=RES.getRes("EXPLine"),this.expLine.x=510,this.expLine.y=33,this.MaxExpW=this.expLine.width,this.plv.x=520,this.pname.x=250,this.pexp.x=this.pexpM.x=625,this.penergy.x=this.penergyM.x=860,this.pdiamond.x=1020,this.plv.y=35,this.pname.y=25,this.penergy.y=25,this.pexp.y=25,this.pdiamond.y=25,this.penergyM.y=this.pexpM.y=27,this.plv.size=35,this.pdiamond.size=this.pname.size=50,this.pexp.size=this.penergy.size=50,this.pexp.verticalAlign=egret.VerticalAlign.BOTTOM,this.plv.fontFamily=this.pname.fontFamily=this.penergy.fontFamily=this.pexp.fontFamily=this.pdiamond.fontFamily="Colonna MT",this.plv.textColor=16777215,this.plv.strokeColor=0,this.plv.stroke=2,this.pexpM.fontFamily=this.penergyM.fontFamily="方正古隶简体",this.pexpM.stroke=this.penergyM.stroke=2,this.pname.textColor=this.pdiamond.textColor=16777215,this.pname.stroke=this.penergy.stroke=this.pexp.stroke=this.pdiamond.stroke=2,this.pname.strokeColor=11141239},p.UpdateStatus=function(){this.plv.text=PlayerData.level.toString(),this.pname.text=PlayerData.playername,this.pexp.text=PlayerData.exp.toString(),this.penergy.text=PlayerData.cur_energy.toString(),this.pdiamond.text=PlayerData.diamond.toString(),this.pexpM.text=" /"+(100*PlayerData.level).toString(),this.penergyM.text=" /"+PlayerData.cur_energy.toString(),this.pexp.anchorOffsetX=this.pexp.textWidth,this.penergy.anchorOffsetX=this.penergy.textWidth,this.energyLine.width=this.MaxApW*(PlayerData.cur_energy/PlayerData.max_energy),this.expLine.width=this.MaxExpW*(PlayerData.exp/(100*PlayerData.level)),this.leader.texture=RES.getRes(PlayerData.leader+"Img"),this.leader.x=(SystemData.stgX-SystemData.mainRightW)/2-this.leader.width/2,this.leader.y=SystemData.stgY-this.leader.height},e}(egret.DisplayObjectContainer);egret.registerClass(MainUI,"MainUI");var NewMember=function(t){function e(){t.call(this),this._showCard=new egret.DisplayObjectContainer,this._getCardAni1=new egret.Bitmap,this._getCardAni2=new egret.Bitmap,this._getCardAni3=new egret.Bitmap,this._mask=new egret.Bitmap,this._touch=new egret.Bitmap,this._touch2=new egret.Bitmap,this.Init()}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(){var t=new egret.Bitmap;t.texture=RES.getRes("MainBG2"),t.width=SystemData.stgX,t.height=SystemData.stgY,this.addChild(t),this._once=new egret.Bitmap,this._once.texture=RES.getRes("once"),this._once.touchEnabled=!0,this._once.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.changeTexture,this),this._once.addEventListener(egret.TouchEvent.TOUCH_END,this.forOnce,this),this._once.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.resetTexture,this),this.addChild(this._once),this._once.x=525,this._once.y=575,this._curCard=new egret.Bitmap,this._curCard.texture=RES.getRes("Karinef"),this._curCard.x=640,this._curCard.y=360,this._curCard.anchorOffsetX=this._curCard.width/2,this._curCard.anchorOffsetY=this._curCard.height/2,this.addChild(this._curCard),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.added,this),this._getCardAni1.texture=RES.getRes("MAINgetcard1"),this._getCardAni2.texture=RES.getRes("MAINgetcard2"),this._getCardAni3.texture=RES.getRes("MAINgetcard3"),this._touch.texture=RES.getRes("MAINtouch"),this._touch2.texture=RES.getRes("MAINtouch2"),this._touch.x=this._touch2.x=919,this._touch.y=this._touch2.y=59,this._mask.texture=RES.getRes("MAINblack"),this._mask.width=1280,this._mask.height=720},p.changeTexture=function(){this._once.texture=RES.getRes("once1")},p.resetTexture=function(){this._once.texture=RES.getRes("once")},p.forOnce=function(){if(this.resetTexture(),this.testSpace()&&!(PlayerData.diamond<=0)){var t=CardPool.getCard();PlayerData.addCard(t),this.playCard(t),PlayerData.diamond--}},p.testSpace=function(){return PlayerData._maxBoxes<=PlayerData._ownCards.length?!1:!0},p.playCard=function(t){var e=RES.getRes("Characters_json"),i=e.character[t].name;this.dispatchEvent(new egret.Event(GameEvent.TEMP_REMOVE_BUTTON,!1,!1,!1)),this._getCardAni1.addEventListener(egret.TouchEvent.TOUCH_TAP,this.tapAni,this),this._getCardAni1.touchEnabled=!0,this._mask.alpha=0,this._touch2.alpha=0,this.addChild(this._mask),egret.Tween.get(this._mask).to({alpha:1},500).call(function(){this.addChildAt(this._getCardAni1,this.getChildIndex(this._mask)),this.addChildAt(this._touch,this.getChildIndex(this._mask)),this.addChildAt(this._touch2,this.getChildIndex(this._mask)),this.playTouch()},this).to({alpha:0},500),this._curCard.scaleX=0,this._curCard.scaleY=0,this._curCard.texture=RES.getRes(i+"f")},p.playTouch=function(){null!=this._touch2.parent&&(this._touch2.alpha<=0&&egret.Tween.get(this._touch2).to({alpha:1},500).call(this.playTouch,this),this._touch2.alpha>=1&&egret.Tween.get(this._touch2).to({alpha:0},500).call(this.playTouch,this))},p.tapAni=function(){this._getCardAni1.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.tapAni,this),null!=this._touch.parent&&this.removeChild(this._touch),null!=this._touch2.parent&&this.removeChild(this._touch2),this.addChild(this._getCardAni2),this.addChild(this._getCardAni3),this._getCardAni2.alpha=this._getCardAni3.alpha=0,this.addChild(this._curCard),egret.Tween.get(this._getCardAni2).to({alpha:1},1e3),egret.Tween.get(this._getCardAni3).to({alpha:.5,scaleX:1,scaleY:1},2e3);var t=this._curCard.texture;this._curCard.texture=RES.getRes("MAINcardback"),egret.Tween.get(this._curCard).to({},1100).to({scaleX:.6,scaleY:.6},900,egret.Ease.circInOut).to({},100).to({scaleX:0},300).call(function(){this._curCard.texture=t},this).to({scaleX:.6},300).call(this.readyback,this)},p.readyback=function(){egret.MainContext.instance.stage.addEventListener(egret.TouchEvent.TOUCH_TAP,this.backtoNew,this)},p.backtoNew=function(){this.removeChild(this._mask),this.addChild(this._mask),egret.Tween.get(this._mask).to({alpha:1},500).call(function(){this.removeChild(this._getCardAni1),this.removeChild(this._getCardAni2),this.removeChild(this._getCardAni3),this._curCard.texture=RES.getRes("empty")},this).to({alpha:0},500).call(this.backOver,this)},p.backOver=function(){this.removeChild(this._mask),egret.MainContext.instance.stage.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.backtoNew,this),this.dispatchEvent(new egret.Event(GameEvent.TEMP_REMOVE_BUTTON,!1,!1,!0))},p.added=function(){this._curCard.texture=RES.getRes("empty")},e}(egret.DisplayObjectContainer);egret.registerClass(NewMember,"NewMember");var GameView=function(t){function e(){t.call(this),this.pageButton=new egret.DisplayObjectContainer}__extends(e,t);var i=(__define,e);return p=i.prototype,p.preInit=function(){this.login=new Login,this.login.addEventListener(GameEvent.START_GAME,this.startGame,this),this.curPage="login",this.addChild(this.login)},p.startGame=function(){this.Init(),this.toCondition()},p.Init=function(){this.mainUI=new MainUI,this.newmemberUI=new NewMember,this.editgroupUI=new EditGroup,this.adventureUI=new Adventure,this.adventureUI.addEventListener(GameEvent.BACK_FROM_ADV,this.toCondition,this),this.InitButton(),this.newmemberUI.addEventListener(GameEvent.TEMP_REMOVE_BUTTON,this.setTempButton,this)},p.InitButton=function(){this._pageSe=new egret.Bitmap,this._pageSe.texture=RES.getRes("page_select"),this.pageButton.addChild(this._pageSe),this._condition=new egret.Bitmap,this._condition.texture=RES.getRes("condition"),this._condition.touchEnabled=!0,this._condition.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toCondition,this),this.pageButton.addChild(this._condition),this._adventure=new egret.Bitmap,this._adventure.texture=RES.getRes("adventure"),this._adventure.touchEnabled=!0,this._adventure.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toAdventure,this),this.pageButton.addChild(this._adventure),this._group=new egret.Bitmap,this._group.texture=RES.getRes("group"),this._group.touchEnabled=!0,this._group.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toGroup,this),this.pageButton.addChild(this._group),this._newmember=new egret.Bitmap,this._newmember.texture=RES.getRes("newmember"),this._newmember.touchEnabled=!0,this._newmember.addEventListener(egret.TouchEvent.TOUCH_TAP,this.toNewmember,this),this.pageButton.addChild(this._newmember),this._pageSeTop=new egret.Bitmap,this._pageSeTop.texture=RES.getRes("page_select_top"),this.pageButton.addChild(this._pageSeTop),this._condition.x=this._adventure.x=this._group.x=this._newmember.x=this._pageSe.x=SystemData.stgX-SystemData.mainRightW,this._condition.y=SystemData.mainUpH+50,this._adventure.y=this._condition.y+this._condition.height,this._group.y=this._adventure.y+this._adventure.height,this._newmember.y=this._group.y+this._group.height,this._settings=new egret.Bitmap,this._settings.x=SystemData.stgX-this._settings.width-35,this._settings.touchEnabled=!0,this._settings.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onSettings,this),this._pageSe.x=this._condition.x,this._pageSeTop.x=this._condition.x},p.toCondition=function(){"mainUI"!=this.curPage&&("login"==this.curPage||"adventure"==this.curPage?(this._pageSe.y=this._condition.y,this._pageSeTop.y=this._condition.y):(egret.Tween.get(this._pageSe).to({y:this._condition.y},200),egret.Tween.get(this._pageSeTop).to({y:this._condition.y},200)),this.removeChildren(),this.addChild(this.mainUI),this.curPage="mainUI",this.addChild(this.pageButton),this.addChild(this._settings))},p.toAdventure=function(){this.removeChildren(),this.addChild(this.adventureUI),this.curPage="adventure"},p.toGroup=function(){"editgroup"!=this.curPage&&("login"==this.curPage||"adventure"==this.curPage?(this._pageSe.y=this._condition.y,this._pageSeTop.y=this._condition.y):(egret.Tween.get(this._pageSe).to({y:this._group.y},200),egret.Tween.get(this._pageSeTop).to({y:this._group.y},200)),this.removeChildren(),this.addChild(this.editgroupUI),this.curPage="editgroup",this.addChild(this.pageButton),this.addChild(this._settings))},p.toNewmember=function(){"newmember"!=this.curPage&&("login"==this.curPage||"adventure"==this.curPage?(this._pageSe.y=this._condition.y,this._pageSeTop.y=this._condition.y):(egret.Tween.get(this._pageSe).to({y:this._newmember.y},200),egret.Tween.get(this._pageSeTop).to({y:this._newmember.y},200)),this.removeChildren(),this.addChild(this.newmemberUI),this.curPage="newmember",this.addChild(this.pageButton),this.addChild(this._settings))},p.activeLogin=function(){this.login.activethis()},p.setProgress=function(t,e){this.login.setProgress(t,e)},p.onSettings=function(){},p.setTempButton=function(t){t.data?this.addChild(this.pageButton):this.removeChild(this.pageButton)},e}(egret.DisplayObjectContainer);egret.registerClass(GameView,"GameView");var LoadingUI=function(t){function e(){t.call(this),this.createView()}__extends(e,t);var i=(__define,e);return p=i.prototype,p.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},p.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.onAddToStage=function(t){console.log("ok"),this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},p.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.loadGroup("preload"),RES.loadGroup("gameRES")},p.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),this.createGameScene()),"gameRES"==t.groupName&&(RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),this.gv.activeLogin())
},p.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},p.onResourceProgress=function(t){"preload"==t.groupName||"gameRES"==t.groupName&&null!=this.gv&&this.gv.setProgress(t.itemsLoaded,t.itemsTotal)},p.createGameScene=function(){AV.initialize("Rmvdne3nVtQrnCtSLG4sUMnJ-gzGzoHsz","hsuTLuGAl951nXL7sSpp9k0y"),this.gv=new GameView,this.addChild(this.gv),this.gv.preInit(),egret.MainContext.instance.stage.addEventListener(egret.TouchEvent.TOUCH_TAP,this.testclick,this)},p.testclick=function(t){},e}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var MySaveData=function(){function t(){}var e=(__define,t);return p=e.prototype,t}();egret.registerClass(MySaveData,"MySaveData");var CardPool=function(){function t(){}var e=(__define,t);return p=e.prototype,t.Init=function(){for(var t=RES.getRes("Characters_json"),e=0;e<t.character.length;e++)switch(t.character[e].rare){case 3:this.star3.push(t.character[e].id);break;case 4:this.star4.push(t.character[e].id);break;case 5:this.star5.push(t.character[e].id)}},t.getCard=function(){var t=0,e=Math.random();if(console.log(e),.7>e){var i=Math.floor(Math.random()*this.star3.length);t=this.star3[i]}else if(.9>e){var i=Math.floor(Math.random()*this.star4.length);t=this.star4[i]}else{var i=Math.floor(Math.random()*this.star5.length);t=this.star5[i]}return console.log(t),t},t.star3=[],t.star4=[],t.star5=[],t}();egret.registerClass(CardPool,"CardPool");var GameEvent=function(){function t(){}var e=(__define,t);return p=e.prototype,t.START_GAME="startgame",t.BACK_FROM_ADV="backfromadv",t.PLOT_OVER="plot over",t.LOSE_FROM_BAT="lose from battle",t.WIN_BATTLE="win battle",t.BACK_FROM_BAT_MAP="back from battle to map",t.BACK_FROM_BAT_MAIN="back from battle to main",t.CHAIN_OVER="chain over",t.TEMP_REMOVE_BUTTON="temp remove button",t.SELECT_BONUS_OVER="select bonus over",t.STOP_BATTLE_PROC="stop battle process",t.CONTINUE_BATTLE="continue battle",t.lOG_IN="log in",t}();egret.registerClass(GameEvent,"GameEvent");var PlayerData=function(){function t(){}var e=(__define,t);return p=e.prototype,t.SetData2=function(e,i){for(var s=0;s<e.cards.length;s++){var a=new CardData;a._pid=e.cards[s].pid,a._id=e.cards[s].id,a._level=e.cards[s].lev,a._exp=e.cards[s].exp,a._name=e.cards[s].name,a._hp=e.cards[s].HP,a._mp=e.cards[s].MP,a._attack=e.cards[s].Attack,a._cure=e.cards[s].Cure,a._speed=e.cards[s].Speed,a._element=e.cards[s].Element,t._ownCards.push(a)}for(var s=0;s<e.groups.length;s++){for(var h=[],r=0;5>r;r++){var n=e.groups[s].members[r];h.push(n)}t._savedGroup.push(h)}for(var s=0;s<e.maplock.length;s++){for(var o=[],r=0;r<e.maplock[s].length;r++){var l=e.maplock[s][r];o.push(l)}t._maplock.push(o)}for(var s=0;s<e.mapfirst.length;s++){for(var d=[],r=0;r<e.mapfirst[s].length;r++){var p=e.mapfirst[s][r];d.push(p)}t._mapfirst.push(d)}for(var s=0;s<e.extraLev.length;s++){for(var c=[],r=0;r<e.extraLev[s].length;r++){var l=e.extraLev[s][r];c.push(l)}t._extraLev.push(c)}-1!=this._savedGroup[0][0]?t.leader=this._ownCards[this._savedGroup[0][0]]._name:t.leader="",i.dispatchEvent(new egret.Event(GameEvent.START_GAME))},t.SetData=function(e,i){var s,a=this,h=new AV.Query("PlayerData");h.equalTo("name",e),h.find().then(function(t){s=t[0].get("data"),a.SetData2(s,i)},function(t){console.log("read data error!")}),t.playername=e},t.addCard=function(e){var i=new CardData;i._id=e,i._level=1,i._exp=0,i._pid=t._ownCards.length;var s=RES.getRes("Characters_json");i._name=s.character[e].name;var a=RES.getRes(i._name+"_json");i._hp=a.oriHP,i._mp=a.oriMP,i._attack=a.oriAttack,i._cure=a.oriCure,i._speed=a.oriSpeed,i._element=a.oriElement,1!=s.oriStory||this._extraLev[e][0]||(this._extraLev[e][0]=!0,this.ShowNewStory(i._name)),t._ownCards.push(i),this.SaveData()},t.getUsedBoxes=function(){return this._ownCards.length},t.UpdateLeader=function(){-1!=t._savedGroup[0][0]?t.leader=t._ownCards[t._savedGroup[0][0]]._name:t.leader=""},t.sumAttributes=function(e){t.sumHP=0,t.sumMP=0,t.sumSp=0,t.sumCur=0;for(var i=0;i<this._savedGroup[e].length;i++)-1!=this._savedGroup[e][i]&&(t.sumHP+=this._ownCards[this._savedGroup[e][i]]._hp,t.sumMP+=this._ownCards[this._savedGroup[e][i]]._mp,t.sumSp+=this._ownCards[this._savedGroup[e][i]]._speed,t.sumCur+=this._ownCards[this._savedGroup[e][i]]._cure)},t.unlockMap=function(t,e){if(3!=t||3!=e){if(e+1<this._maplock[t].length?this._maplock[t][e+1]=!0:e+1==this._maplock[t].length?t+1<this._maplock.length&&(this._maplock[t+1][0]=!0):console.log("map error！"),!this._mapfirst[t][e]){var i=RES.getRes((t+1).toString()+"-"+(e+1).toString()+"_json"),s=i.firstCard;null!=s&&this.addCard(s),this._mapfirst[t][e]=!0}this.SaveData()}},t.putExp=function(t,e,i){for(this.exp+=t;this.exp>=100*this.level;)this.exp=this.exp-100*this.level,this.level++;for(var s=0;s<this._savedGroup[i].length;s++){var a=this._savedGroup[i][s];if(-1!=a){this._ownCards[a]._exp+=e;for(var h=RES.getRes(this._ownCards[a]._name+"_json");this._ownCards[a]._exp>=100*this._ownCards[a]._level;){if(this._ownCards[a]._exp-=100*this._ownCards[a]._level,this._ownCards[a]._level++,25==this._ownCards[a]._level){var r=this._ownCards[a]._id;this._extraLev[r][1]||(this._extraLev[r][1]=!0,this.ShowNewStory(this._ownCards[a]._name))}if(this._ownCards[a]._level>50){this._ownCards[a]._level=50,this._ownCards[a]._exp=5e3;break}this._ownCards[a]._hp+=(h.maxHP-h.oriHP)/50,this._ownCards[a]._mp+=(h.maxMP-h.oriMP)/50,this._ownCards[a]._attack+=(h.maxAttack-h.oriAttack)/50,this._ownCards[a]._speed+=(h.maxSpeed-h.oriSpeed)/50,this._ownCards[a]._cure+=(h.maxCure-h.oriCure)/50}}}},t.ShowNewStory=function(t){PubDialog.ShowNewStory(t)},t.SaveData=function(){var e=RES.getRes("EmptyData_json");e.cards[0];e.cards=[];for(var i=0;i<this._ownCards.length;i++){var s=new MySaveData;s.pid=this._ownCards[i]._pid,s.id=this._ownCards[i]._id,s.lev=this._ownCards[i]._level,s.exp=this._ownCards[i]._exp,s.name=this._ownCards[i]._name,s.HP=this._ownCards[i]._hp,s.MP=this._ownCards[i]._mp,s.Attack=this._ownCards[i]._attack,s.Cure=this._ownCards[i]._cure,s.Speed=this._ownCards[i]._speed,s.Element=this._ownCards[i]._element,e.cards.push(s)}for(var i=0;i<this._savedGroup.length;i++)for(var a=0;a<this._savedGroup[i].length;a++)e.groups[i].members[a]=this._savedGroup[i][a];for(var i=0;i<this._maplock.length;i++)for(var a=0;a<this._maplock[i].length;a++)e.maplock[i][a]=this._maplock[i][a];for(var i=0;i<this._mapfirst.length;i++)for(var a=0;a<this._mapfirst[i].length;a++)e.mapfirst[i][a]=this._mapfirst[i][a];for(var i=0;i<this._extraLev.length;i++)for(var a=0;a<this._extraLev[i].length;a++)e.extraLev[i][a]=this._extraLev[i][a];var h=new AV.Query("PlayerData");h.equalTo("name",t.playername),h.find().then(function(t){0==t.length?console.log("error!"):(t[0].set("data",e),t[0].save())},function(t){})},t.playername="Chris",t.level=1,t.exp=0,t.max_energy=80,t.cur_energy=80,t.diamond=20,t.leader="Karine",t._maxBoxes=100,t._ownCards=[],t._savedGroup=[],t._maplock=[],t._mapfirst=[],t._extraLev=[],t}();egret.registerClass(PlayerData,"PlayerData");var PubDialog=function(){function t(){}var e=(__define,t);return p=e.prototype,t.ShowNewStory=function(t){egret.MainContext.instance.stage.addChild(this._container);var e=new egret.Bitmap;e.texture=RES.getRes("MAINblack"),e.alpha=.5,e.touchEnabled=!0,e.width=SystemData.stgX,e.height=SystemData.stgY,this._container.addChild(e),this.bg=e;var i=new egret.Bitmap;i.texture=RES.getRes(t+"Img"),i.x=-i.width,i.y=50,this._container.addChild(i),egret.Tween.get(i).to({x:200},500,egret.Ease.circOut);var s=new egret.Bitmap;s.texture=RES.getRes("MAINNewStory"),this._container.addChild(s),s.x=SystemData.stgX,s.y=450,egret.Tween.get(s).to({x:600},500,egret.Ease.circOut).call(this.AniOver,this)},t.AniOver=function(){egret.MainContext.instance.stage.addEventListener(egret.TouchEvent.TOUCH_TAP,this.clearContainer,this)},t.clearContainer=function(){egret.MainContext.instance.stage.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.clearContainer,this),this._container.removeChildren(),egret.MainContext.instance.stage.removeChild(this._container)},t._container=new egret.DisplayObjectContainer,t}();egret.registerClass(PubDialog,"PubDialog");var SystemData=function(){function t(){}var e=(__define,t);return p=e.prototype,t.stgX=1280,t.stgY=720,t.mainRightW=150,t.mainUpH=80,t.cIconSize=80,t.wCardW=272,t.wCardH=82,t.hCardW=175,t.hCardH=271,t.groupWidth=944,t.unsetCharacter=[],t}();egret.registerClass(SystemData,"SystemData");var CardData=function(){function t(){}var e=(__define,t);return p=e.prototype,t}();egret.registerClass(CardData,"CardData");var CardGroup=function(t){function e(e){t.call(this),this._member=[],this._curSelected=-1,this.SelectMark=new egret.Bitmap,this.curGetID=-1,this._disHP=new egret.TextField,this._disMP=new egret.TextField,this._disCur=new egret.TextField,this._disSpeed=new egret.TextField,this._dislskill=new egret.TextField,this.Init(e)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(t){this.SelectMark.texture=RES.getRes("MAINselected");var e=new egret.Bitmap;e.texture=RES.getRes("GroupBG2"),this.addChild(e),this.bgb=e,this.gid=t;for(var i=0;5>i;i++){var s=new DisplayCard;s.addEventListener(egret.TouchEvent.TOUCH_TAP,this.getTap,this),s.gid=i,s.x=30+i*SystemData.hCardW,s.y=25,this.addChild(s),this._member.push(s)}this._disHP.y=this._disMP.y=this._disCur.y=this._disSpeed.y=SystemData.hCardH+55,this._dislskill.y=this._disHP.y+32,this._disHP.x=this._member[0].x+180,this._disMP.x=this._disHP.x+150,this._disCur.x=this._disHP.x+300,this._disSpeed.x=this._disHP.x+450,this._dislskill.x=30,this._disHP.size=this._disMP.size=this._disCur.size=this._disSpeed.size=this._dislskill.size=22,this._disHP.fontFamily=this._disMP.fontFamily=this._disCur.fontFamily=this._disSpeed.fontFamily=this._dislskill.fontFamily="经典粗宋简",this.addChild(this._disHP),this.addChild(this._disMP),this.addChild(this._disCur),this.addChild(this._disSpeed),this.addChild(this._dislskill);var a=new egret.Bitmap;a.texture=RES.getRes("GroupBG"),a.x=-35,a.y=-25,this.addChild(a),a.pixelHitTest=!0,e.x=-38,e.y=-25,this.addChild(this.SelectMark),this.updateSe(),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.UpdateData,this),this.addEventListener(egret.Event.REMOVED_FROM_STAGE,this.removed,this)},p.getTap=function(t){this._curSelected==t.target.gid?this._curSelected=-1:(this._curSelected=t.target.gid,-1!=this.curGetID&&this.testAtri(this.curGetID)),this.updateSe()},p.UpdateData=function(){for(var t=0;t<this._member.length;t++)this._member[t].SetContent(PlayerData._savedGroup[this.gid][t],"high");PlayerData.sumAttributes(this.gid),this._disHP.text="HP:"+PlayerData.sumHP.toFixed(0),this._disMP.text="MP:"+PlayerData.sumMP.toFixed(0),this._disCur.text="回:"+PlayerData.sumCur.toFixed(0),this._disSpeed.text="速:"+PlayerData.sumSp.toFixed(0),this._disHP.textColor=this._disMP.textColor=this._disCur.textColor=this._disSpeed.textColor=16777215;var e=PlayerData._savedGroup[this.gid][0];if(-1!=e){var i=RES.getRes("Characters_json"),s=i.character[PlayerData._ownCards[e]._id].name,a=RES.getRes(s+"_json"),h=a.lskill;this._dislskill.text=h}else this._dislskill.text="";this._dislskill.x=472-this._dislskill.textWidth/2},p.InputID=function(t){if(-1!=this._curSelected){for(var e=0;e<this._member.length;e++)t==this._member[e].pid&&(PlayerData._savedGroup[this.gid][e]=this._member[this._curSelected].pid);PlayerData._savedGroup[this.gid][this._curSelected]=t,this.UpdateData(),this._curSelected=-1,this.updateSe()}},p.removed=function(){this._curSelected=-1},p.ShowInfo=function(){for(var t=0;t<this._member.length;t++)this._member[t].showInfo()},p.haveLeader=function(){return-1!=this._member[0].pid?!0:!1},p.updateSe=function(){-1==this._curSelected?this.SelectMark.visible=!1:(this.SelectMark.x=this._member[this._curSelected].x,this.SelectMark.y=this._member[this._curSelected].y,this.SelectMark.visible=!0)},p.testAtri=function(t){if(-1!=this._curSelected){for(var e=0;e<this._member.length;e++)if(this._member[e].pid==t)return void this.UpdateData();for(var i=0,s=0,a=0,h=0,e=0;e<this._member.length;e++)-1!=this._member[e].pid&&(e!=this._curSelected?(i+=PlayerData._ownCards[this._member[e].pid]._hp,s+=PlayerData._ownCards[this._member[e].pid]._mp,a+=PlayerData._ownCards[this._member[e].pid]._cure,h+=PlayerData._ownCards[this._member[e].pid]._speed):(i+=PlayerData._ownCards[t]._hp,s+=PlayerData._ownCards[t]._mp,a+=PlayerData._ownCards[t]._cure,h+=PlayerData._ownCards[t]._speed));PlayerData.sumAttributes(this.gid),this._disHP.text="HP:"+i.toFixed(0),i>PlayerData.sumHP?this._disHP.textColor=65280:i<PlayerData.sumHP?this._disHP.textColor=16711680:this._disHP.textColor=16777215,this._disMP.text="MP:"+s.toFixed(0),s>PlayerData.sumMP?this._disMP.textColor=65280:s<PlayerData.sumMP?this._disMP.textColor=16711680:this._disMP.textColor=16777215,this._disCur.text="回:"+a.toFixed(0),a>PlayerData.sumCur?this._disCur.textColor=65280:a<PlayerData.sumCur?this._disCur.textColor=16711680:this._disCur.textColor=16777215,this._disSpeed.text="速:"+h.toFixed(0),h>PlayerData.sumSp?this._disSpeed.textColor=65280:h<PlayerData.sumSp?this._disSpeed.textColor=16711680:this._disSpeed.textColor=16777215}},p.removeGroupInfo=function(){this.removeChild(this._disHP),this.removeChild(this._disMP),this.removeChild(this._disCur),this.removeChild(this._disSpeed),this.removeChild(this._dislskill),this.removeChild(this.bgb),this.touchChildren=!1},e}(egret.DisplayObjectContainer);egret.registerClass(CardGroup,"CardGroup");var ChatData=function(){function t(){this.pic=[],this.pos=[]}var e=(__define,t);return p=e.prototype,t}();egret.registerClass(ChatData,"ChatData");var DisplayCard=function(t){function e(){t.call(this),this.gid=-1,this._info=new egret.DisplayObjectContainer,this.detailInfor=new egret.DisplayObjectContainer,this._timer=new egret.Timer(500,1),this._inforBG=new egret.Bitmap,this._disA1=new egret.TextField,this._disA2=new egret.TextField,this._lvText=new egret.TextField,this.Init()}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(){this._content=new egret.Bitmap,this.touchEnabled=!0,this.addChild(this._content),this._inforBG=new egret.Bitmap,this._inforBG.texture=RES.getRes("infoBG"),this._info.addChild(this._inforBG),this._disA1.size=this._disA2.size=18,this._disA1.textColor=this._disA2.textColor=0,this._disA1.x=10,this._disA1.y=this._disA2.y=5,this._disA1.fontFamily=this._disA2.fontFamily="经典细隶书简",this._info.addChild(this._disA1),this._info.addChild(this._disA2),this._disA2.x=this._inforBG.width/2+10,this._info.y=SystemData.hCardH-this._inforBG.height,this._lvText.size=18,this._lvText.y=60,this._lvText.stroke=1},p.SetContent=function(t,e){switch(this.pid=t,e){case"icong":-1!=t&&(this._content.texture=RES.getRes(PlayerData._ownCards[t]._name+"i"),this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.StartTimer,this),this._lvText.text="Lv "+PlayerData._ownCards[t]._level.toString(),this._lvText.x=40-this._lvText.textWidth/2,this.addChild(this._lvText));break;case"high":-1!=t?(this._content.texture=RES.getRes(PlayerData._ownCards[t]._name),this.setInfo()):(this._content.texture=RES.getRes("empty"),this._content.width=SystemData.hCardW,this._content.height=SystemData.hCardH,this.setInfo());break;case"icon":-1!=t&&(this._content.texture=RES.getRes(PlayerData._ownCards[t]._name+"w"))}},p.setInfo=function(){-1!=this.pid&&(this._disA1.text="攻击:"+PlayerData._ownCards[this.pid]._attack.toFixed(0)+"\n回复:"+PlayerData._ownCards[this.pid]._cure.toFixed(0)+"\n速度:"+PlayerData._ownCards[this.pid]._speed.toFixed(0),this._disA2.text="HP:"+PlayerData._ownCards[this.pid]._hp.toFixed(0)+"\nMP:"+PlayerData._ownCards[this.pid]._mp.toFixed(0)),this.SetInfoBG()},p.showInfo=function(){null==this._info.parent?this.addChild(this._info):this.removeChild(this._info)},p.SetInfoBG=function(){-1==this.pid?this._inforBG.visible=!1:this._inforBG.visible=!0},p.StartTimer=function(){this._timer.start(),this._timer.addEventListener(egret.TimerEvent.TIMER_COMPLETE,this.ShowDetails,this),this.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.StopTimer,this),this.addEventListener(egret.TouchEvent.TOUCH_END,this.StopTimer,this)},p.StopTimer=function(){this._timer.removeEventListener(egret.TimerEvent.TIMER_COMPLETE,this.ShowDetails,this),this.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.StopTimer,this),this.removeEventListener(egret.TouchEvent.TOUCH_END,this.StopTimer,this),this._timer.stop(),this._timer.reset()},p.ShowDetails=function(){this.stage.addChild(this.detailInfor);var t=new egret.Bitmap;t.texture=RES.getRes("MAINfullInfo"),this.detailInfor.addChild(t);var e=new egret.Bitmap;PlayerData._ownCards[this.pid]._level<25?e.texture=RES.getRes(PlayerData._ownCards[this.pid]._name+"f"):e.texture=RES.getRes(PlayerData._ownCards[this.pid]._name+"f"),this.detailInfor.addChild(e),e.touchEnabled=!0,egret.MainContext.instance.stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.removeDetails,this);for(var i=PlayerData._ownCards[this.pid],s=(i._id,i._name),a=RES.getRes(s+"_json"),h=0;11>h;h++){var r=new egret.TextField;if(this.detailInfor.addChild(r),r.size=20,r.fontFamily="Monotype Corsiva",0==h)r.text=i._level.toString(),r.x=652,r.y=30,r.size=40;else if(1==h){r.text=i._exp.toString(),r.x=1068,r.y=85;var n=new egret.Bitmap;n.texture=RES.getRes("MAINcexpLine"),n.width=n.width*(i._exp/(100*i._level)),n.x=573,n.y=62,this.detailInfor.addChild(n)}else 2==h?(1==i._element?r.text="火":2==i._element?r.text="水":3==i._element?r.text="风":4==i._element?r.text="光":5==i._element&&(r.text="暗"),r.x=671,r.y=160,r.fontFamily="经典粗宋简"):3==h?(r.text=i._hp.toFixed(0),r.x=872,r.y=160):4==h?(r.text=i._mp.toFixed(0),r.x=1060,r.y=160):5==h?(r.text=i._attack.toFixed(0),r.x=671,r.y=208):6==h?(r.text=i._cure.toFixed(0),r.x=872,r.y=208):7==h?(r.text=i._speed.toFixed(0),r.x=1060,r.y=208):8==h?(r.text=a.skill+"。消耗mp"+a.skillcost.toString()+"。",r.x=675,r.y=355,r.fontFamily="经典粗宋简"):9==h?(r.text=a.lskill+"。",r.x=675,r.y=407,r.fontFamily="经典粗宋简"):10==h&&(r.text=a.profile,r.x=600,r.y=540,r.fontFamily="经典粗宋简",r.width=590,r.lineSpacing=5,r.wordWrap=!0)}},p.removeDetails=function(t){egret.MainContext.instance.stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.removeDetails,this),this.stage.removeChild(this.detailInfor),this.detailInfor.removeChildren(),this.StopTimer()},e}(egret.DisplayObjectContainer);egret.registerClass(DisplayCard,"DisplayCard");var LevelManage=function(t){function e(){t.call(this),this.story=[],this.wintext=new egret.Bitmap,this.expCards=[],this.BounsCards=[]}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(t,e){this.gid=e;var i=RES.getRes(t+"_json");this.levelNo1=i.no1,this.levelNo2=i.no2,this.levelExp=i.exp,this.ClevelExp=i.cexp,this.BonusCardPID=i.bonus,this.BonusCardChance=i.bonusChance;for(var s=RES.getRes(t+"plot_json"),a=0;a<s.length;a++){var h=new Story;h.Init(t,a),this.story.push(h)}this.battle=new BattleMain,this.battle.Init(t),console.log(this.story),this.addChild(this.story[0]),this.story[0].addEventListener(GameEvent.PLOT_OVER,this.plotover,this),this.winboard=new egret.Bitmap,this.winboard.touchEnabled=!0,this.winboard.texture=RES.getRes("MAINwinboard"),this.loseboard=new egret.Bitmap,this.loseboard.touchEnabled=!0,this.loseboard.texture=RES.getRes("MAINloseboard"),this.wintext.texture=RES.getRes("MAINwintext")},p.plotover=function(){this.removeChild(this.story[0]),this.story[0].removeEventListener(GameEvent.PLOT_OVER,this.plotover,this),this.addChild(this.battle),this.battle.addEventListener(GameEvent.LOSE_FROM_BAT,this.lose,this),this.battle.addEventListener(GameEvent.WIN_BATTLE,this.win,this)},p.lose=function(){this.addChild(this.loseboard),this.loseboard.addEventListener(egret.TouchEvent.TOUCH_TAP,this.back,this)},p.win=function(){this.addChild(this.winboard),this.ShowEXP(),this.ShowBonus(),this.addChild(this.wintext),PlayerData.unlockMap(this.levelNo1,this.levelNo2),PlayerData.putExp(this.levelExp,this.ClevelExp,this.gid)},p.back=function(){PlayerData.SaveData(),this.dispatchEvent(new egret.Event(GameEvent.BACK_FROM_BAT_MAP))},p.plotafter=function(){egret.MainContext.instance.stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.plotafter,this),this.story.length>1?(this.removeChild(this.battle),this.addChild(this.story[1]),this.story[1].addEventListener(GameEvent.PLOT_OVER,this.back,this)):this.back()},p.ShowEXP=function(){for(var t=0;t<PlayerData._savedGroup[this.gid].length;t++){var e=new WinShowCard(PlayerData._savedGroup[this.gid][t],!0);e.PutInEXP(this.ClevelExp),e.x=421+172*t,e.y=96,this.expCards.push(e),this.addChild(e)}var i=new WinShowCard(-1,!1);i.PutInEXP(this.levelExp),i.x=435,i.y=365,this.addChild(i),this.expCards.push(i)},p.FinishEXP=function(){for(var t=0;t<this.expCards.length;t++)this.expCards[t].FinishEXP()},p.ShowBonus=function(){for(var t=0;4>t;t++){var e=new BonusCard;e.id=t,e.scaleX=.35,e.scaleY=.35;var i=Math.random();i<this.BonusCardChance?(e.pid=this.BonusCardPID,e.type="character"):(i=Math.random(),.6>i?e.type="exp":.95>i?e.type="cexp":e.type="diamond"),this.BounsCards.push(e),this.addChild(e),e.x=318+200*t,e.y=392,e.addEventListener(egret.TouchEvent.TOUCH_TAP,this.endBonus,this)}},p.endBonus=function(t){for(var e=0;e<this.BounsCards.length;e++)this.BounsCards[e].touchEnabled=!1,this.BounsCards[e].Show();switch(this.BounsCards[t.target.id].type){case"exp":PlayerData.putExp(this.levelExp/2,0,this.gid);break;case"cexp":PlayerData.putExp(0,this.ClevelExp/2,this.gid);break;case"diamond":PlayerData.diamond++;break;case"character":PlayerData.addCard(this.BounsCards[t.target.id].pid)}this.FinishEXP(),egret.MainContext.instance.stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.plotafter,this,!1,0)},e}(egret.DisplayObjectContainer);egret.registerClass(LevelManage,"LevelManage");var BonusCard=function(t){function e(){t.call(this),this.id=0,this.pid=-1,this.texture=RES.getRes("MAINcardback"),this.touchEnabled=!0}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Show=function(){console.log(this.type),this.anchorOffsetX=this.width/2,this.anchorOffsetY=this.height/2,this.x+=.35*this.anchorOffsetX,this.y+=.35*this.anchorOffsetY,egret.Tween.get(this).to({scaleX:0},500).call(this.SelectTexture,this).to({scaleX:.35},500)},p.SelectTexture=function(){if("exp"==this.type)this.texture=RES.getRes("BATexp");else if("cexp"==this.type)this.texture=RES.getRes("BATcexp");else if("diamond"==this.type)this.texture=RES.getRes("BATdiamond");else if("character"==this.type){var t=RES.getRes("Characters_json");this.texture=RES.getRes(t.character[this.pid].name+"f")}this.dispatchEvent(new egret.Event(GameEvent.SELECT_BONUS_OVER))},e}(egret.Bitmap);egret.registerClass(BonusCard,"BonusCard");var WinShowCard=function(t){function e(e,i){t.call(this),this._active=!0,this.cexp=new egret.Bitmap,this.cexpM=new egret.Bitmap,this.levelup=new egret.Bitmap,this.expText=new egret.TextField,this.lvText=new egret.TextField,this.myTimer=new egret.Timer(20),this.oriLv=0,this.oriEXP=0,this.addEXP=0,this.expRate=1,this.type=!0,this.Init(e,i)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(t,e){if(-1==t&&e)return void(this._active=!1);if(this.cexp.texture=RES.getRes("BATline"),this.cexpM.texture=RES.getRes("BATlineM"),this.levelup.texture=RES.getRes("MAINLevelup"),e){var i=PlayerData._ownCards[t];this.oriLv=i._level,this.oriEXP=i._exp;var s=new egret.Bitmap;s.texture=RES.getRes(i._name),this.addChild(s),this.cexp.y=this.cexpM.y=235,this.cexp.x=s.width/2-this.cexp.width/2,this.cexpM.x=this.cexp.x,this.expText.y=this.lvText.y=210,this.expText.x=100,this.lvText.x=10}else this.cexp.texture=RES.getRes("BATPline"),this.cexpM.texture=RES.getRes("BATPlineM"),this.oriLv=PlayerData.level,this.oriEXP=PlayerData.exp,this.cexpM.width=750,this.expText.x=this.cexpM.width+10,this.lvText.x=-50;this.expText.size=this.lvText.size=25,this.expText.fontFamily=this.lvText.fontFamily="Monotype Corsiva",this.expText.stroke=this.lvText.stroke=1,this.expText.strokeColor=this.lvText.strokeColor=0,this.addChild(this.cexp),this.addChild(this.cexpM),this.addChild(this.expText),this.addChild(this.lvText)},p.updateAll=function(){this._active&&(this.cexp.width=this.cexpM.width*this.oriEXP/(100*this.oriLv),this.expText.text="exp +"+this.addEXP.toFixed(0),this.lvText.text="Lv "+this.oriLv.toFixed(0))},p.PutInEXP=function(t){this._active&&(this.addEXP=t,this.updateAll(),this.expRate=t/200,this.myTimer.start(),this.myTimer.addEventListener(egret.TimerEvent.TIMER,this.EXPup,this))},p.FinishEXP=function(){if(this._active){for(this.myTimer.stop(),this.myTimer.reset(),this.myTimer.removeEventListener(egret.TimerEvent.TIMER,this.EXPup,this),this.oriEXP+=this.addEXP;this.oriEXP>=100*this.oriLv;)if(this.oriEXP-=100*this.oriLv,this.oriLv++,this.oriLv>50&&this.type){this.oriLv=50,this.oriEXP=5e3;break}this.addEXP=0,this.updateAll()}},p.EXPup=function(){this._active&&(this.addEXP-this.expRate<0?(this.oriEXP+=this.addEXP,this.addEXP=0):(this.oriEXP+=this.expRate,this.addEXP-=this.expRate),this.oriEXP>=100*this.oriLv&&(this.oriEXP-=100*this.oriLv,this.oriLv++,this.oriLv>50&&this.type?(this.oriLv=50,this.oriEXP=5e3):this.addChild(this.levelup)),this.addEXP<=0&&(this.myTimer.stop(),this.myTimer.reset(),this.myTimer.removeEventListener(egret.TimerEvent.TIMER,this.EXPup,this)),this.updateAll())},e}(egret.DisplayObjectContainer);egret.registerClass(WinShowCard,"WinShowCard");var Password=function(t){function e(){t.call(this),this.username=new egret.TextField,this.pass=new egret.TextField,this.login=new egret.Bitmap,this.Logo=new egret.Bitmap,this.fog1=new egret.Bitmap,this.fog2=new egret.Bitmap,this.myMask=new egret.Bitmap,this.Init()}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(){var t=new egret.Bitmap;t.texture=RES.getRes("LoginBG_png"),this.addChild(t),t.name="logBG",this.myMask.texture=RES.getRes("logMask_png"),this.login.texture=RES.getRes("LoginButton"),this.addChild(this.login),this.login.x=495,this.login.y=530,this.login.touchEnabled=!0,this.username.type=this.pass.type=egret.TextFieldType.INPUT,this.pass.displayAsPassword=!0,this.username.x=483,this.username.y=325,this.username.width=300,this.username.size=30,this.username.text="Chris",this.username.textAlign=egret.HorizontalAlign.CENTER,this.username.textColor=0,this.pass.x=483,this.pass.y=460,this.pass.width=300,this.pass.size=30,this.pass.textAlign=egret.HorizontalAlign.CENTER,this.pass.text="000000",this.pass.textColor=0,this.connectT=new egret.Bitmap,this.connectT.texture=RES.getRes("connectBG_png"),this.connectT.x=520,this.connectT.y=567,this.connectG=new egret.Bitmap,this.connectG.texture=RES.getRes("connecting_png"),this.connectG.anchorOffsetX=this.connectG.width/2,this.connectG.anchorOffsetY=this.connectG.height/2,this.connectG.x=628,this.connectG.y=580,this.Logo.texture=RES.getRes("logLogo_png"),this.Logo.name="Logo",this.fog1.texture=RES.getRes("fog_png"),this.fog2.texture=RES.getRes("fog_png"),this.fog1.y=75,this.fog2.y=110,this.fog1.name="fog1",this.fog2.name="fog2",this.Logo.x=egret.MainContext.instance.stage.stageWidth/2-this.Logo.width/2-25,this.Logo.y=50,this.fog1.x=this.Logo.x-764,this.fog2.x=this.Logo.x-20+380-744,this.addChild(this.fog1),this.addChild(this.fog2),this.addChild(this.Logo),this.addChild(this.username),this.addChild(this.pass),this.addChild(this.myMask),this.login.addEventListener(egret.TouchEvent.TOUCH_TAP,this.Log,this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.addedpre,this)},p.addedpre=function(){for(var t=0;t<this.numChildren;t++){var e=this.getChildAt(t);e.alpha=0}this.playFog(),this.playFogAlpha(),egret.Tween.get(this.Logo).to({alpha:.8},800).call(this.added,this).to({alpha:1},200),egret.Tween.get(this.fog1).to({alpha:.6},1e3),egret.Tween.get(this.fog2).to({alpha:.5},1e3),this.myMask.alpha=1},p.added=function(){for(var t=0;t<this.numChildren;t++){var e=this.getChildAt(t);if("Logo"!=e.name&&"LogoShadow"!=e.name&&"fog1"!=e.name&&"fog2"!=e.name)if("logBG"==e.name){var i=e.height;e.height=0,e.fillMode=egret.BitmapFillMode.REPEAT,egret.Tween.get(e).to({height:i,alpha:1},1e3)}else egret.Tween.get(e).to({},1e3).to({alpha:1},1500)}},p.Log=function(){this.connect();var t=new AV.Query("PlayerData"),e=this,i=this.username.text;t.equalTo("name",i),t.find().then(function(t){if(0!=t.length){var s=t[0].get("Password");e.pass.text==s?e.dispatchEvent(new egret.Event(GameEvent.lOG_IN,!1,!1,i)):e.recover()}else e.recover()},function(t){console.log("error!")})},p.playFog=function(){null!=this.fog1.stage&&(this.fog1.x==this.Logo.x-764?(egret.Tween.get(this.fog1).to({x:this.Logo.x-20},24e3).call(this.playFog,this),egret.Tween.get(this.fog2).to({x:this.Logo.x-744-764+380},2e4)):(this.fog1.x=this.Logo.x-764,this.fog2.x=this.Logo.x-20+380-744,this.playFog()))},p.playFogAlpha=function(){null!=this.fog1.stage&&(.2==this.fog2.alpha?egret.Tween.get(this.fog2).to({alpha:.5},15e3).call(this.playFogAlpha,this):egret.Tween.get(this.fog2).to({alpha:.2},15e3).call(this.playFogAlpha,this))},p.playConnect=function(){null!=this.connectG.stage&&(0==this.connectG.rotation?egret.Tween.get(this.connectG).to({rotation:360},1e3).call(function(){this.playConnect()},this):(this.connectG.rotation=0,this.playConnect()))},p.connect=function(){null!=this.login.parent&&this.removeChild(this.login),this.addChild(this.connectG),this.playConnect(),this.addChild(this.connectT)},p.recover=function(){null!=this.connectG.parent&&this.removeChild(this.connectG),null!=this.connectT.parent&&this.removeChild(this.connectT),this.addChild(this.login)},e}(egret.DisplayObjectContainer);egret.registerClass(Password,"Password");var Story=function(t){function e(){t.call(this),this.speakerName=new egret.TextField,this.speakerNamePic=new egret.Bitmap,this.chatContent=new egret.TextField,this.disPic=new egret.DisplayObjectContainer,this.skip=new egret.Bitmap,this.speakerBox=new egret.Bitmap,this.chatData=[],this.curChat=0}__extends(e,t);var i=(__define,e);return p=i.prototype,p.Init=function(t,e){var i=RES.getRes(t+"plot_json"),s=i[e];this.bg=new egret.Bitmap;var a=s.bg;this.bg.texture=RES.getRes(a),this.dialogBox=new egret.Bitmap,this.dialogBox.texture=RES.getRes("dialogBox"),this.dialogBox.touchEnabled=!0,this.dialogBox.pixelHitTest=!0,this.speakerName.x=120,this.speakerName.rotation=-10,this.speakerName.y=440,this.speakerName.size=33,this.speakerName.fontFamily="微软雅黑",this.speakerName.stroke=5,this.speakerName.strokeColor=0,this.chatContent.x=110,this.chatContent.y=505,this.chatContent.width=1050,this.chatContent.wordWrap=!0,this.chatContent.lineSpacing=10,this.chatContent.fontFamily="微软雅黑",this.chatContent.textColor=0,this.chatContent.size=25,this.speakerBox.texture=RES.getRes("namebox"),this.speakerBox.x=10,this.speakerBox.y=this.speakerName.y-45,this.speakerNamePic.x=this.speakerBox.x,this.speakerNamePic.y=this.speakerBox.y,this.addChild(this.bg),this.addChild(this.disPic),this.addChild(this.dialogBox),this.addChild(this.speakerName),this.addChild(this.chatContent),this.addChild(this.speakerBox),this.addChild(this.speakerNamePic),this.dialogBox.addEventListener(egret.TouchEvent.TOUCH_TAP,this.updateDialog,this);for(var e=0;e<s.plot.length;e++){var h=new ChatData;h.speaker=s.plot[e].speaker,h.text=s.plot[e].text;for(var r=0;r<s.plot[e].image.length;r++){h.pic.push(s.plot[e].image[r]);var n=s.plot[e].pos[r].x,o=s.plot[e].pos[r].y,l=new egret.Point(n,o);h.pos.push(l)}this.chatData.push(h)}this.updateDialog(),this.skip.texture=RES.getRes("MAINskip"),this.skip.touchEnabled=!0,this.skip.addEventListener(egret.TouchEvent.TOUCH_TAP,this.skipstory,this),this.skip.x=1180,this.addChild(this.skip)},p.updateDialog=function(){if(this.curChat>=this.chatData.length)return void this.dispatchEvent(new egret.Event(GameEvent.PLOT_OVER));this.speakerName.text=this.chatData[this.curChat].speaker,this.speakerBox.visible=!0,this.speakerName.visible=!0,this.speakerNamePic.visible=!1,"default"==this.speakerName.text?this.speakerName.text=PlayerData.playername:""==this.speakerName.text?this.speakerBox.visible=!1:(this.speakerNamePic.texture=RES.getRes(this.speakerName.text+"n"),null==this.speakerNamePic.texture?this.speakerNamePic.texture=RES.getRes("empty"):(this.speakerNamePic.visible=!0,this.speakerName.visible=!1,this.speakerBox.visible=!1)),this.speakerName.anchorOffsetX=this.speakerName.measuredWidth/2,this.chatContent.text=this.chatData[this.curChat].text,this.chatContent.text=this.chatContent.text.replace("default",PlayerData.playername),this.disPic.removeChildren();
for(var t=0;t<this.chatData[this.curChat].pic.length;t++){var e=new egret.Bitmap;this.disPic.addChild(e),e.texture=RES.getRes(this.chatData[this.curChat].pic[t]),e.x=this.chatData[this.curChat].pos[t].x,e.y=this.chatData[this.curChat].pos[t].y}this.curChat++},p.skipstory=function(){this.dispatchEvent(new egret.Event(GameEvent.PLOT_OVER))},e}(egret.DisplayObjectContainer);egret.registerClass(Story,"Story");